// Prisma Schema for Hisham Traders ERP

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// CORE TABLES (Epic 1)
// ============================================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // ADMIN, WAREHOUSE_MANAGER, SALES_OFFICER, ACCOUNTANT, RECOVERY_AGENT
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

// ============================================================================
// REFERENCE TABLES (Epic 2 - Lookup/Master Data)
// ============================================================================

model Country {
  id        String    @id @default(cuid())
  code      String    @unique  // "CN", "PK", "AE", "US", etc.
  name      String    @unique  // "China", "Pakistan", "UAE", "United States"
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  suppliers Supplier[]

  @@map("countries")
}

model PaymentTerm {
  id          String    @id @default(cuid())
  name        String    @unique  // "Net 30", "50% Advance + 50% on Delivery", etc.
  description String?   @db.Text
  days        Int?      // For calculating due dates (30, 60, etc.)
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  suppliers   Supplier[]

  @@map("payment_terms")
}

model ProductCategory {
  id          String    @id @default(cuid())
  name        String    @unique  // "Sinks", "Faucets", "Toilets", "Showers", "Accessories"
  description String?   @db.Text
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("product_categories")
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  country   String?   // Brand origin country (optional)
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products  Product[]

  @@map("brands")
}

model UnitOfMeasure {
  id           String    @id @default(cuid())
  name         String    @unique  // "Piece", "Box", "Case", etc.
  abbreviation String    @unique  // "pc", "box", "cs", etc.
  description  String?   @db.Text
  active       Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  products     Product[]

  @@map("units_of_measure")
}

// ============================================================================
// SUPPLIER MANAGEMENT (Epic 2.1)
// ============================================================================

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id            String         @id @default(cuid())
  name          String         @unique

  // Foreign keys to reference tables
  countryId     String?
  paymentTermId String?

  contactPerson String?
  email         String?        @unique
  phone         String?
  address       String?        @db.Text
  status        SupplierStatus @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  country       Country?           @relation(fields: [countryId], references: [id])
  paymentTerm   PaymentTerm?       @relation(fields: [paymentTermId], references: [id])
  purchaseOrders PurchaseOrder[]
  payments      Payment[]

  @@index([status])
  @@index([countryId])
  @@index([paymentTermId])
  @@map("suppliers")
}

// ============================================================================
// WAREHOUSE MANAGEMENT (Epic 2.5)
// ============================================================================

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

model Warehouse {
  id        String          @id @default(cuid())
  name      String          @unique
  location  String?         @db.Text  // Full address
  city      String?
  status    WarehouseStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  gatePassMode     GatePassMode    @default(AUTO)

  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoices         Invoice[]
  gatePasses       GatePass[]
  binLocations     BinLocation[]          // Story 6.5
  outboundTransfers  StockTransfer[] @relation("TransferSource")       // Story 6.4
  inboundTransfers   StockTransfer[] @relation("TransferDestination")  // Story 6.4
  stockCounts        StockCount[]   // Story 6.9

  @@index([status])
  @@map("warehouses")
}

// ============================================================================
// GATE PASS SYSTEM (Epic 6.1-6.3)
// ============================================================================

enum GatePassMode {
  AUTO
  MANUAL
}

enum GatePassPurpose {
  SALE
  TRANSFER
  RETURN
  OTHER
}

enum GatePassStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model GatePass {
  id              String          @id @default(cuid())
  gatePassNumber  String          @unique
  warehouseId     String
  date            DateTime
  purpose         GatePassPurpose
  referenceType   ReferenceType?
  referenceId     String?
  status          GatePassStatus  @default(PENDING)
  issuedBy        String
  approvedBy      String?
  dispatchedBy    String?
  completedBy     String?
  cancelReason    String?         @db.Text
  notes           String?         @db.Text

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id])
  issuer          User            @relation("IssuedGatePasses", fields: [issuedBy], references: [id])
  approver        User?           @relation("ApprovedGatePasses", fields: [approvedBy], references: [id])
  items           GatePassItem[]

  @@index([warehouseId])
  @@index([status])
  @@index([date])
  @@index([referenceType, referenceId])
  @@map("gate_passes")
}

model GatePassItem {
  id          String   @id @default(cuid())
  gatePassId  String
  productId   String
  batchNo     String?
  binLocation String?
  quantity    Int
  description String?  @db.Text

  createdAt   DateTime @default(now())

  gatePass    GatePass @relation(fields: [gatePassId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([gatePassId])
  @@index([productId])
  @@map("gate_pass_items")
}

// ============================================================================
// INVENTORY & STOCK MOVEMENTS (Story 2.6)
// ============================================================================

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  productVariantId String?
  warehouseId String
  quantity    Int      @default(0)
  batchNo     String?
  binLocation String?
  expiryDate  DateTime?  // Story 6.7

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])

  @@unique([productId, productVariantId, warehouseId, batchNo])
  @@index([productId])
  @@index([warehouseId])
  @@index([productVariantId])
  @@map("inventory")
}

enum MovementType {
  RECEIPT
  SALE
  ADJUSTMENT
  TRANSFER
  SALES_RETURN
}

enum ReferenceType {
  PO
  INVOICE
  ADJUSTMENT
  TRANSFER
  CREDIT_NOTE
}

model StockMovement {
  id            String         @id @default(cuid())
  productId     String
  productVariantId String?
  warehouseId   String
  movementType  MovementType
  quantity      Int
  referenceType ReferenceType?
  referenceId   String?
  movementDate  DateTime       @default(now())
  userId        String
  notes         String?        @db.Text

  createdAt     DateTime       @default(now())

  product         Product          @relation(fields: [productId], references: [id])
  productVariant  ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  user            User             @relation(fields: [userId], references: [id])
  stockAdjustment StockAdjustment?

  @@index([productId])
  @@index([warehouseId])
  @@index([movementDate])
  @@index([referenceType, referenceId])
  @@index([productVariantId])
  @@map("stock_movements")
}

// ============================================================================
// STOCK ADJUSTMENTS (Story 2.8)
// ============================================================================

enum AdjustmentType {
  WASTAGE
  DAMAGE
  THEFT
  CORRECTION
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

model StockAdjustment {
  id               String           @id @default(cuid())
  productId        String
  productVariantId String?
  warehouseId      String
  adjustmentType   AdjustmentType
  quantity         Int              // Can be positive or negative
  reason           String           @db.Text
  notes            String?          @db.Text
  status           AdjustmentStatus @default(PENDING)

  // Workflow tracking
  createdBy        String
  createdAt        DateTime         @default(now())
  reviewedBy       String?
  reviewedAt       DateTime?
  rejectionReason  String?          @db.Text

  // Link to stock movement (created on approval)
  stockMovementId  String?          @unique

  // Relations
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse        Warehouse        @relation(fields: [warehouseId], references: [id])
  creator          User             @relation("AdjustmentCreator", fields: [createdBy], references: [id])
  reviewer         User?            @relation("AdjustmentReviewer", fields: [reviewedBy], references: [id])
  stockMovement    StockMovement?   @relation(fields: [stockMovementId], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@index([productVariantId])
  @@map("stock_adjustments")
}

// ============================================================================
// PRODUCT MANAGEMENT (Epic 2.4)
// ============================================================================

enum ProductStatus {
  ACTIVE
  INACTIVE
}

model Product {
  id            String         @id @default(cuid())
  sku           String         @unique
  name          String

  // Foreign keys to reference tables
  categoryId    String?
  brandId       String?
  uomId         String?

  // Variant support flag
  hasVariants   Boolean        @default(false)

  // Base pricing (used when hasVariants=false, or as fallback)
  costPrice     Decimal        @db.Decimal(10, 2)
  sellingPrice  Decimal        @db.Decimal(10, 2)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        ProductStatus  @default(ACTIVE)

  // Batch/Expiry tracking (Story 6.7)
  hasExpiry     Boolean        @default(false)
  shelfLifeDays Int?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  brand         Brand?           @relation(fields: [brandId], references: [id])
  uom           UnitOfMeasure?   @relation(fields: [uomId], references: [id])
  variants         ProductVariant[]
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]
  creditNoteItems  CreditNoteItem[]   // Story 3.9
  gatePassItems    GatePassItem[]     // Epic 6
  stockTransferItems StockTransferItem[] // Story 6.4
  stockCountItems    StockCountItem[]    // Story 6.9

  @@index([status])
  @@index([sku])
  @@index([categoryId])
  @@index([brandId])
  @@index([uomId])
  @@index([hasVariants])
  @@map("products")
}

// ============================================================================
// PURCHASE ORDER MANAGEMENT (Epic 2.2)
// ============================================================================

enum POStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id                  String   @id @default(cuid())
  poNumber            String   @unique
  supplierId          String
  orderDate           DateTime
  expectedArrivalDate DateTime?
  status              POStatus @default(PENDING)
  totalAmount         Decimal  @db.Decimal(12, 2)
  notes               String?  @db.Text

  // Import documentation fields (Story 2.3)
  containerNo         String?
  shipDate            DateTime?
  arrivalDate         DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?

  supplier            Supplier @relation(fields: [supplierId], references: [id])
  items               POItem[]
  costs               POCost[] // Story 2.3: Additional costs

  @@index([status])
  @@index([supplierId])
  @@index([orderDate])
  @@map("purchase_orders")
}

// ============================================================================
// PO ADDITIONAL COSTS (Story 2.3)
// ============================================================================

enum POCostType {
  SHIPPING
  CUSTOMS
  TAX
  OTHER
}

model POCost {
  id            String      @id @default(cuid())
  poId          String
  type          POCostType
  amount        Decimal     @db.Decimal(10, 2)
  description   String?     @db.Text

  createdAt     DateTime    @default(now())
  createdBy     String?

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@index([poId])
  @@map("po_costs")
}

// ============================================================================
// PRODUCT VARIANTS (Epic 2.4.1)
// ============================================================================

enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id            String         @id @default(cuid())
  productId     String
  sku           String         @unique // Variant-specific SKU (e.g., PROD-2025-001-RED-M)
  variantName   String         // e.g., "Red / Medium", "250mm / Chrome"

  // Variant attributes stored as JSON for flexibility
  // Example: {"color": "Red", "size": "Medium"} or {"length": "250mm", "finish": "Chrome"}
  attributes    Json

  // Variant-specific pricing (overrides base product pricing)
  costPrice     Decimal        @db.Decimal(10, 2)
  sellingPrice  Decimal        @db.Decimal(10, 2)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        VariantStatus  @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  product          Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]
  creditNoteItems  CreditNoteItem[]   // Story 3.9

  @@index([productId])
  @@index([sku])
  @@index([status])
  @@map("product_variants")
}

model POItem {
  id              String          @id @default(cuid())
  poId            String
  productId       String
  productVariantId String?       // Optional: references specific variant
  quantity        Int
  unitCost        Decimal         @db.Decimal(10, 2)
  totalCost       Decimal         @db.Decimal(12, 2)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  updatedBy       String?

  purchaseOrder   PurchaseOrder   @relation(fields: [poId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([poId])
  @@index([productId])
  @@index([productVariantId])
  @@map("po_items")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  roleId       String
  status       String    @default("active") // active, inactive
  lastLoginAt  DateTime?
  tenantId     String?   // For multi-tenant Phase 3 (not enforced in MVP)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  role                Role              @relation(fields: [roleId], references: [id])
  auditLogs           AuditLog[]
  stockMovements      StockMovement[]
  createdAdjustments  StockAdjustment[] @relation("AdjustmentCreator")
  reviewedAdjustments StockAdjustment[] @relation("AdjustmentReviewer")
  payments            Payment[]         @relation("PaymentRecorder")
  voidedInvoices      Invoice[]         @relation("VoidedInvoices")  // Story 3.4
  expenses            Expense[]         // Story 3.7
  creditNotesCreated  CreditNote[]      @relation("CreditNoteCreator") // Story 3.9
  journalEntriesCreated  JournalEntry[]  @relation("JournalEntryCreator")   // Epic 5
  journalEntriesApproved JournalEntry[]  @relation("JournalEntryApprover")  // Epic 5
  bankReconciliations    BankReconciliation[] @relation("BankReconciler")    // Epic 5
  periodCloses           PeriodClose[]   @relation("PeriodCloser")          // Epic 5
  issuedGatePasses       GatePass[]      @relation("IssuedGatePasses")      // Epic 6
  approvedGatePasses     GatePass[]      @relation("ApprovedGatePasses")    // Epic 6
  requestedTransfers     StockTransfer[] @relation("TransferRequester")     // Story 6.4
  approvedTransfers      StockTransfer[] @relation("TransferApprover")      // Story 6.4
  createdStockCounts     StockCount[]    @relation("StockCountCreator")     // Story 6.9
  recoveryClients        Client[]        @relation("RecoveryAgentClients")  // Epic 7
  recoveryVisits         RecoveryVisit[] @relation("RecoveryVisits")        // Epic 7
  createdPromises        PaymentPromise[] @relation("CreatedPromises")      // Epic 7
  alertsReceived         Alert[]         @relation("AlertTargetUser")       // Epic 7
  alertsAcknowledged     Alert[]         @relation("AlertAcknowledger")     // Epic 7
  changeHistory          ChangeHistory[]                                    // Epic 8

  @@index([email])
  @@index([roleId])
  @@index([status])
  @@index([tenantId])
  @@map("users")
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  action        String   // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
  entityType    String   // User, Product, Invoice, Payment, etc.
  entityId      String?
  timestamp     DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  changedFields Json?    // { field: { old: value, new: value } }
  notes         String?  @db.Text

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
  @@index([action])
  @@map("audit_logs")
}

// ============================================================================
// CHANGE HISTORY (Epic 8.2 â€” Version Comparison)
// ============================================================================

model ChangeHistory {
  id           String   @id @default(cuid())
  entityType   String   // PRODUCT, CLIENT, SUPPLIER, PURCHASE_ORDER, INVOICE, PAYMENT
  entityId     String
  version      Int
  changedBy    String?
  changedAt    DateTime @default(now())
  snapshot     Json     // Whitelisted fields snapshot at time of change
  changeReason String?  @db.Text

  user User? @relation(fields: [changedBy], references: [id])

  @@unique([entityType, entityId, version])
  @@index([entityType, entityId])
  @@map("change_history")
}

// ============================================================================
// PAYMENT TRACKING (Epic 2.10)
// ============================================================================

enum PaymentType {
  SUPPLIER
  CLIENT
}

enum PaymentReferenceType {
  PO
  INVOICE
  GENERAL
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
}

model Payment {
  id                   String                 @id @default(cuid())
  supplierId           String?
  clientId             String?                // Story 3.6: Client payment support
  paymentType          PaymentType
  paymentReferenceType PaymentReferenceType?
  referenceId          String?                // PO ID or Invoice ID (deprecated for client payments, use allocations)
  amount               Decimal                @db.Decimal(12, 2)
  method               PaymentMethod
  referenceNumber      String?                // Story 3.6: Cheque/Bank transfer reference
  date                 DateTime
  notes                String?                @db.Text
  recordedBy           String
  bankAccountId        String?                // Epic 5: Link to bank account head

  createdAt            DateTime               @default(now())

  supplier             Supplier?              @relation(fields: [supplierId], references: [id])
  client               Client?                @relation(fields: [clientId], references: [id])
  user                 User                   @relation("PaymentRecorder", fields: [recordedBy], references: [id])
  bankAccount          AccountHead?           @relation("PaymentBankAccount", fields: [bankAccountId], references: [id])
  allocations          PaymentAllocation[]    // Story 3.6: Payment allocation to invoices

  @@index([paymentType, paymentReferenceType, referenceId])
  @@index([supplierId])
  @@index([clientId])
  @@index([date])
  @@index([bankAccountId])
  @@map("payments")
}

// Story 3.6: Payment Allocation for Invoice Payments
model PaymentAllocation {
  id        String   @id @default(cuid())
  paymentId String
  invoiceId String
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())

  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([paymentId])
  @@index([invoiceId])
  @@map("payment_allocations")
}

// ============================================================================
// CLIENT MANAGEMENT (Epic 3.1)
// ============================================================================

enum ClientStatus {
  ACTIVE
  INACTIVE
}

model Client {
  id              String       @id @default(cuid())
  name            String
  contactPerson   String?
  phone           String?
  whatsapp        String?
  email           String?
  city            String?
  area            String?
  creditLimit     Decimal      @db.Decimal(12, 2) @default(0)
  paymentTermsDays Int         @default(30)
  balance         Decimal      @db.Decimal(12, 2) @default(0)
  status          ClientStatus @default(ACTIVE)

  // Tax exemption (Story 3.5)
  taxExempt       Boolean      @default(false)
  taxExemptReason String?      @db.Text

  // Recovery management (Epic 7)
  recoveryDay       RecoveryDay? @default(NONE)
  recoveryAgentId   String?

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  invoices        Invoice[]
  payments        Payment[]            // Story 3.6: Client payments
  creditNotes     CreditNote[]         // Story 3.9: Credit notes
  recoveryAgent   User?                @relation("RecoveryAgentClients", fields: [recoveryAgentId], references: [id])
  recoveryVisits  RecoveryVisit[]      // Epic 7
  paymentPromises PaymentPromise[]     // Epic 7

  @@index([recoveryAgentId])
  @@map("clients")
}

// ============================================================================
// SYSTEM SETTINGS (Story 3.2)
// ============================================================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique  // e.g., "TAX_RATE", "CURRENCY", "BUSINESS_NAME"
  value     String   @db.Text
  dataType  String   // "number", "string", "boolean"
  label     String   // Human-readable label
  category  String?  // "tax", "general", "invoice", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}

// ============================================================================
// SALES INVOICES (Story 3.2)
// ============================================================================

enum InvoiceStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  VOIDED  // Story 3.4: Invoice voiding
}

enum InvoicePaymentType {
  CASH
  CREDIT
}

model Invoice {
  id            String               @id @default(cuid())
  invoiceNumber String               @unique
  clientId      String
  warehouseId   String
  invoiceDate   DateTime
  dueDate       DateTime
  paymentType   InvoicePaymentType
  subtotal      Decimal              @db.Decimal(12, 2)
  taxAmount     Decimal              @db.Decimal(12, 2)
  taxRate       Decimal              @db.Decimal(5, 2) @default(0) // Snapshot of tax rate at creation (Story 3.5)
  total         Decimal              @db.Decimal(12, 2)
  paidAmount    Decimal              @db.Decimal(12, 2) @default(0)
  status        InvoiceStatus        @default(PENDING)
  notes         String?              @db.Text

  // Story 3.4: Void tracking
  voidedAt      DateTime?
  voidedBy      String?
  voidReason    String?              @db.Text

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  client        Client               @relation(fields: [clientId], references: [id])
  warehouse     Warehouse            @relation(fields: [warehouseId], references: [id])
  voider        User?                @relation("VoidedInvoices", fields: [voidedBy], references: [id])
  items         InvoiceItem[]
  allocations   PaymentAllocation[]  // Story 3.6: Payment allocations
  creditNotes   CreditNote[]         // Story 3.9: Credit notes / sales returns

  @@index([clientId])
  @@index([warehouseId])
  @@index([status])
  @@index([invoiceDate])
  @@map("invoices")
}

model InvoiceItem {
  id               String          @id @default(cuid())
  invoiceId        String
  productId        String
  productVariantId String?
  batchNo          String?
  quantity         Int
  unitPrice        Decimal         @db.Decimal(10, 2)
  discount         Decimal         @db.Decimal(5, 2) @default(0)
  total            Decimal         @db.Decimal(12, 2)

  invoice          Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])
  creditNoteItems  CreditNoteItem[] // Story 3.9: Credit note line items

  @@index([invoiceId])
  @@index([productId])
  @@index([productVariantId])
  @@map("invoice_items")
}

// ============================================================================
// EXPENSE TRACKING (Story 3.7)
// ============================================================================

enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  SUPPLIES
  MAINTENANCE
  MARKETING
  TRANSPORT
  MISC
}

model Expense {
  id            String          @id @default(cuid())
  category      ExpenseCategory
  amount        Decimal         @db.Decimal(12, 2)
  description   String          @db.Text
  date          DateTime
  paymentMethod PaymentMethod
  receiptUrl    String?         @db.Text
  recordedBy    String

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation(fields: [recordedBy], references: [id])

  @@index([category])
  @@index([date])
  @@index([recordedBy])
  @@map("expenses")
}

// ============================================================================
// CREDIT NOTES / SALES RETURNS (Story 3.9)
// ============================================================================

enum CreditNoteStatus {
  OPEN
  APPLIED
  VOIDED
}

model CreditNote {
  id               String           @id @default(cuid())
  creditNoteNumber String           @unique
  invoiceId        String
  clientId         String
  reason           String           @db.Text
  subtotal         Decimal          @db.Decimal(12, 2)
  taxRate          Decimal          @db.Decimal(5, 2)  @default(0)
  taxAmount        Decimal          @db.Decimal(12, 2)
  totalAmount      Decimal          @db.Decimal(12, 2)
  status           CreditNoteStatus @default(OPEN)
  createdBy        String

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  invoice          Invoice          @relation(fields: [invoiceId], references: [id])
  client           Client           @relation(fields: [clientId], references: [id])
  creator          User             @relation("CreditNoteCreator", fields: [createdBy], references: [id])
  items            CreditNoteItem[]

  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("credit_notes")
}

model CreditNoteItem {
  id               String          @id @default(cuid())
  creditNoteId     String
  invoiceItemId    String
  productId        String
  productVariantId String?
  batchNo          String?
  quantityReturned Int
  unitPrice        Decimal         @db.Decimal(10, 2)
  discount         Decimal         @db.Decimal(5, 2)  @default(0)
  total            Decimal         @db.Decimal(12, 2)

  createdAt        DateTime        @default(now())

  creditNote       CreditNote      @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  invoiceItem      InvoiceItem     @relation(fields: [invoiceItemId], references: [id])
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([creditNoteId])
  @@index([invoiceItemId])
  @@index([productId])
  @@index([productVariantId])
  @@map("credit_note_items")
}

// ============================================================================
// ACCOUNTING - GENERAL LEDGER (Epic 5)
// ============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountStatus {
  ACTIVE
  INACTIVE
}

enum JournalEntryStatus {
  DRAFT
  POSTED
}

enum ReconciliationStatus {
  IN_PROGRESS
  COMPLETED
}

enum PeriodType {
  MONTH
  YEAR
}

enum PeriodCloseStatus {
  CLOSED
  REOPENED
}

model AccountHead {
  id              String        @id @default(cuid())
  code            String        @unique
  name            String
  accountType     AccountType
  parentId        String?
  openingBalance  Decimal       @db.Decimal(14, 2) @default(0)
  currentBalance  Decimal       @db.Decimal(14, 2) @default(0)
  status          AccountStatus @default(ACTIVE)
  isSystemAccount Boolean       @default(false)
  description     String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  parent          AccountHead?  @relation("AccountHeadHierarchy", fields: [parentId], references: [id])
  children        AccountHead[] @relation("AccountHeadHierarchy")
  journalLines    JournalEntryLine[]
  bankReconciliations BankReconciliation[]
  payments        Payment[]     @relation("PaymentBankAccount")

  @@index([accountType])
  @@index([parentId])
  @@index([status])
  @@map("account_heads")
}

model JournalEntry {
  id              String             @id @default(cuid())
  entryNumber     String             @unique
  date            DateTime
  description     String             @db.Text
  status          JournalEntryStatus @default(DRAFT)
  referenceType   String?
  referenceId     String?
  createdBy       String
  approvedBy      String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  creator         User               @relation("JournalEntryCreator", fields: [createdBy], references: [id])
  approver        User?              @relation("JournalEntryApprover", fields: [approvedBy], references: [id])
  lines           JournalEntryLine[]
  closingPeriods  PeriodClose[]      @relation("ClosingJournalEntry")

  @@index([status])
  @@index([date])
  @@index([referenceType, referenceId])
  @@index([createdBy])
  @@map("journal_entries")
}

model JournalEntryLine {
  id              String        @id @default(cuid())
  journalEntryId  String
  accountHeadId   String
  debitAmount     Decimal       @db.Decimal(14, 2) @default(0)
  creditAmount    Decimal       @db.Decimal(14, 2) @default(0)
  description     String?       @db.Text

  createdAt       DateTime      @default(now())

  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])
  reconciliationItems BankReconciliationItem[]

  @@index([journalEntryId])
  @@index([accountHeadId])
  @@map("journal_entry_lines")
}

model BankReconciliation {
  id               String               @id @default(cuid())
  bankAccountId    String
  statementDate    DateTime
  statementBalance Decimal              @db.Decimal(14, 2)
  systemBalance    Decimal              @db.Decimal(14, 2)
  status           ReconciliationStatus @default(IN_PROGRESS)
  reconciledBy     String

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  bankAccount      AccountHead          @relation(fields: [bankAccountId], references: [id])
  reconciler       User                 @relation("BankReconciler", fields: [reconciledBy], references: [id])
  items            BankReconciliationItem[]

  @@index([bankAccountId])
  @@index([status])
  @@map("bank_reconciliations")
}

model BankReconciliationItem {
  id                  String             @id @default(cuid())
  reconciliationId    String
  journalEntryLineId  String?
  description         String             @db.Text
  statementAmount     Decimal            @db.Decimal(14, 2)
  statementDate       DateTime
  matched             Boolean            @default(false)
  notes               String?            @db.Text

  createdAt           DateTime           @default(now())

  reconciliation      BankReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  journalEntryLine    JournalEntryLine?  @relation(fields: [journalEntryLineId], references: [id])

  @@index([reconciliationId])
  @@index([journalEntryLineId])
  @@map("bank_reconciliation_items")
}

model PeriodClose {
  id                    String           @id @default(cuid())
  periodType            PeriodType
  periodDate            DateTime
  netProfit             Decimal          @db.Decimal(14, 2)
  status                PeriodCloseStatus @default(CLOSED)
  closedBy              String
  closingJournalEntryId String?
  reopenReason          String?          @db.Text

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  closer                User             @relation("PeriodCloser", fields: [closedBy], references: [id])
  closingJournalEntry   JournalEntry?    @relation("ClosingJournalEntry", fields: [closingJournalEntryId], references: [id])

  @@unique([periodType, periodDate])
  @@index([status])
  @@map("period_closes")
}

// ============================================================================
// STOCK TRANSFERS (Story 6.4)
// ============================================================================

enum TransferStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model StockTransfer {
  id                     String         @id @default(cuid())
  transferNumber         String         @unique
  sourceWarehouseId      String
  destinationWarehouseId String
  status                 TransferStatus @default(PENDING)
  requestedBy            String
  approvedBy             String?
  dispatchedBy           String?
  completedBy            String?
  notes                  String?        @db.Text

  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  sourceWarehouse        Warehouse      @relation("TransferSource", fields: [sourceWarehouseId], references: [id])
  destinationWarehouse   Warehouse      @relation("TransferDestination", fields: [destinationWarehouseId], references: [id])
  requester              User           @relation("TransferRequester", fields: [requestedBy], references: [id])
  approver               User?          @relation("TransferApprover", fields: [approvedBy], references: [id])
  items                  StockTransferItem[]

  @@index([sourceWarehouseId])
  @@index([destinationWarehouseId])
  @@index([status])
  @@index([createdAt])
  @@map("stock_transfers")
}

model StockTransferItem {
  id               String        @id @default(cuid())
  stockTransferId  String
  productId        String
  batchNo          String?
  quantity         Int
  receivedQuantity Int?
  notes            String?       @db.Text

  createdAt        DateTime      @default(now())

  stockTransfer    StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)
  product          Product       @relation(fields: [productId], references: [id])

  @@index([stockTransferId])
  @@index([productId])
  @@map("stock_transfer_items")
}

// ============================================================================
// BIN LOCATIONS (Story 6.5)
// ============================================================================

model BinLocation {
  id          String   @id @default(cuid())
  warehouseId String
  code        String
  zone        String?
  description String?  @db.Text
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@map("bin_locations")
}

// ============================================================================
// PHYSICAL STOCK COUNTS (Story 6.9)
// ============================================================================

enum CountStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model StockCount {
  id          String      @id @default(cuid())
  countNumber String      @unique
  warehouseId String
  status      CountStatus @default(PLANNED)
  countDate   DateTime
  notes       String?     @db.Text
  createdBy   String
  completedBy String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  warehouse   Warehouse   @relation(fields: [warehouseId], references: [id])
  creator     User        @relation("StockCountCreator", fields: [createdBy], references: [id])
  items       StockCountItem[]

  @@index([warehouseId])
  @@index([status])
  @@index([countDate])
  @@map("stock_counts")
}

model StockCountItem {
  id             String    @id @default(cuid())
  stockCountId   String
  productId      String
  batchNo        String?
  binLocation    String?
  systemQuantity Int
  countedQuantity Int?
  variance       Int?
  notes          String?   @db.Text

  createdAt      DateTime  @default(now())

  stockCount     StockCount @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  product        Product    @relation(fields: [productId], references: [id])

  @@index([stockCountId])
  @@index([productId])
  @@map("stock_count_items")
}

// ============================================================================
// RECOVERY & COLLECTION MANAGEMENT (Epic 7)
// ============================================================================

enum RecoveryDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  NONE
}

enum VisitOutcome {
  PAYMENT_COLLECTED
  PROMISE_MADE
  CLIENT_UNAVAILABLE
  REFUSED_TO_PAY
  PARTIAL_PAYMENT
  DISPUTE_RAISED
  OTHER
}

enum PromiseStatus {
  PENDING
  FULFILLED
  PARTIAL
  BROKEN
  CANCELLED
}

enum AlertType {
  CLIENT_OVERDUE
  PROMISE_BROKEN
  STOCK_LOW
  EXPIRY_WARNING
  CREDIT_LIMIT_EXCEEDED
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertAction {
  NOTIFY
  EMAIL
  SMS
}

model RecoveryVisit {
  id              String       @id @default(cuid())
  visitNumber     String       @unique
  clientId        String
  visitDate       DateTime
  visitTime       String?
  outcome         VisitOutcome
  amountCollected Decimal      @db.Decimal(12, 2) @default(0)
  promiseDate     DateTime?
  promiseAmount   Decimal?     @db.Decimal(12, 2)
  notes           String?      @db.Text
  visitedBy       String
  latitude        Float?
  longitude       Float?

  createdAt       DateTime     @default(now())

  client          Client       @relation(fields: [clientId], references: [id])
  visitor         User         @relation("RecoveryVisits", fields: [visitedBy], references: [id])
  paymentPromise  PaymentPromise?

  @@index([clientId, visitDate])
  @@index([visitedBy])
  @@map("recovery_visits")
}

model PaymentPromise {
  id                String        @id @default(cuid())
  clientId          String
  promiseDate       DateTime
  promiseAmount     Decimal       @db.Decimal(12, 2)
  actualPaymentDate DateTime?
  actualAmount      Decimal?      @db.Decimal(12, 2)
  status            PromiseStatus @default(PENDING)
  recoveryVisitId   String?       @unique
  notes             String?       @db.Text
  createdBy         String

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  client            Client        @relation(fields: [clientId], references: [id])
  recoveryVisit     RecoveryVisit? @relation(fields: [recoveryVisitId], references: [id])
  creator           User          @relation("CreatedPromises", fields: [createdBy], references: [id])

  @@index([clientId, status])
  @@index([promiseDate, status])
  @@map("payment_promises")
}

model AlertRule {
  id          String        @id @default(cuid())
  name        String        @unique
  daysOverdue Int
  priority    AlertPriority
  targetRoles Json
  action      AlertAction
  isActive    Boolean       @default(true)

  createdAt   DateTime      @default(now())

  @@map("alert_rules")
}

model Alert {
  id              String        @id @default(cuid())
  type            AlertType
  priority        AlertPriority
  message         String        @db.Text
  relatedType     String?
  relatedId       String?
  targetUserId    String?
  targetRole      String?
  acknowledged    Boolean       @default(false)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  expiresAt       DateTime?

  createdAt       DateTime      @default(now())

  targetUser      User?         @relation("AlertTargetUser", fields: [targetUserId], references: [id])
  acknowledger    User?         @relation("AlertAcknowledger", fields: [acknowledgedBy], references: [id])

  @@index([targetUserId, acknowledged])
  @@index([type, relatedId])
  @@index([targetRole, acknowledged])
  @@map("alerts")
}
