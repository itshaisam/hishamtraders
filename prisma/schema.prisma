// Prisma Schema for Hisham Traders ERP

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// TENANT MODEL (Epic 9 - Multi-Tenant SaaS)
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  status    String   @default("active") // active, suspended, cancelled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                  User[]
  suppliers              Supplier[]
  warehouses             Warehouse[]
  binLocations           BinLocation[]
  products               Product[]
  productVariants        ProductVariant[]
  purchaseOrders         PurchaseOrder[]
  poItems                POItem[]
  poCosts                POCost[]
  inventory              Inventory[]
  stockMovements         StockMovement[]
  stockAdjustments       StockAdjustment[]
  stockTransfers         StockTransfer[]
  stockTransferItems     StockTransferItem[]
  stockCounts            StockCount[]
  stockCountItems        StockCountItem[]
  clients                Client[]
  invoices               Invoice[]
  invoiceItems           InvoiceItem[]
  creditNotes            CreditNote[]
  creditNoteItems        CreditNoteItem[]
  payments               Payment[]
  paymentAllocations     PaymentAllocation[]
  expenses               Expense[]
  gatePasses             GatePass[]
  gatePassItems          GatePassItem[]
  accountHeads           AccountHead[]
  journalEntries         JournalEntry[]
  journalEntryLines      JournalEntryLine[]
  bankReconciliations    BankReconciliation[]
  bankReconciliationItems BankReconciliationItem[]
  periodCloses           PeriodClose[]
  recoveryVisits         RecoveryVisit[]
  paymentPromises        PaymentPromise[]
  alerts                 Alert[]
  alertRules             AlertRule[]
  goodsReceiveNotes      GoodsReceiveNote[]
  goodsReceiveNoteItems  GoodsReceiveNoteItem[]
  grnCosts               GRNCost[]
  systemSettings         SystemSetting[]
  changeHistories        ChangeHistory[]
  auditLogs              AuditLog[]
  salesOrders            SalesOrder[]
  salesOrderItems        SalesOrderItem[]
  deliveryNotes          DeliveryNote[]
  deliveryNoteItems      DeliveryNoteItem[]
  purchaseInvoices       PurchaseInvoice[]
  purchaseInvoiceItems   PurchaseInvoiceItem[]

  @@map("tenants")
}

// ============================================================================
// CORE TABLES (Epic 1)
// ============================================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // ADMIN, WAREHOUSE_MANAGER, SALES_OFFICER, ACCOUNTANT, RECOVERY_AGENT
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

// ============================================================================
// REFERENCE TABLES (Epic 2 - Lookup/Master Data)
// ============================================================================

model Country {
  id        String    @id @default(cuid())
  code      String    @unique  // "CN", "PK", "AE", "US", etc.
  name      String    @unique  // "China", "Pakistan", "UAE", "United States"
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  suppliers Supplier[]

  @@map("countries")
}

model PaymentTerm {
  id          String    @id @default(cuid())
  name        String    @unique  // "Net 30", "50% Advance + 50% on Delivery", etc.
  description String?   @db.Text
  days        Int?      // For calculating due dates (30, 60, etc.)
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  suppliers   Supplier[]

  @@map("payment_terms")
}

model ProductCategory {
  id          String    @id @default(cuid())
  name        String    @unique  // "Sinks", "Faucets", "Toilets", "Showers", "Accessories"
  description String?   @db.Text
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("product_categories")
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  country   String?   // Brand origin country (optional)
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products  Product[]

  @@map("brands")
}

model UnitOfMeasure {
  id           String    @id @default(cuid())
  name         String    @unique  // "Piece", "Box", "Case", etc.
  abbreviation String    @unique  // "pc", "box", "cs", etc.
  description  String?   @db.Text
  active       Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  products     Product[]

  @@map("units_of_measure")
}

// ============================================================================
// SUPPLIER MANAGEMENT (Epic 2.1)
// ============================================================================

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id            String         @id @default(cuid())
  name          String

  // Foreign keys to reference tables
  countryId     String?
  paymentTermId String?

  contactPerson String?
  email         String?
  phone         String?
  address       String?        @db.Text
  status        SupplierStatus @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  tenantId      String

  // Relations
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  country       Country?           @relation(fields: [countryId], references: [id])
  paymentTerm   PaymentTerm?       @relation(fields: [paymentTermId], references: [id])
  purchaseOrders   PurchaseOrder[]
  payments         Payment[]
  purchaseInvoices PurchaseInvoice[]  // Epic 10

  @@unique([tenantId, name])
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([status])
  @@index([countryId])
  @@index([paymentTermId])
  @@map("suppliers")
}

// ============================================================================
// WAREHOUSE MANAGEMENT (Epic 2.5)
// ============================================================================

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

model Warehouse {
  id        String          @id @default(cuid())
  name      String
  location  String?         @db.Text  // Full address
  city      String?
  status    WarehouseStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  gatePassMode     GatePassMode    @default(AUTO)
  tenantId         String

  // Relations
  tenant           Tenant          @relation(fields: [tenantId], references: [id])
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoices         Invoice[]
  gatePasses       GatePass[]
  binLocations     BinLocation[]          // Story 6.5
  outboundTransfers  StockTransfer[] @relation("TransferSource")       // Story 6.4
  inboundTransfers   StockTransfer[] @relation("TransferDestination")  // Story 6.4
  stockCounts        StockCount[]   // Story 6.9
  goodsReceiveNotes  GoodsReceiveNote[] // GRN
  salesOrders        SalesOrder[]       // Epic 10
  deliveryNotes      DeliveryNote[]     // Epic 10

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([status])
  @@map("warehouses")
}

// ============================================================================
// GATE PASS SYSTEM (Epic 6.1-6.3)
// ============================================================================

enum GatePassMode {
  AUTO
  MANUAL
}

enum GatePassPurpose {
  SALE
  TRANSFER
  RETURN
  OTHER
}

enum GatePassStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model GatePass {
  id              String          @id @default(cuid())
  gatePassNumber  String
  warehouseId     String
  date            DateTime
  purpose         GatePassPurpose
  referenceType   ReferenceType?
  referenceId     String?
  status          GatePassStatus  @default(PENDING)
  issuedBy        String
  approvedBy      String?
  dispatchedBy    String?
  completedBy     String?
  cancelReason    String?         @db.Text
  notes           String?         @db.Text

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  tenantId        String

  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id])
  issuer          User            @relation("IssuedGatePasses", fields: [issuedBy], references: [id])
  approver        User?           @relation("ApprovedGatePasses", fields: [approvedBy], references: [id])
  items           GatePassItem[]

  @@unique([tenantId, gatePassNumber])
  @@index([tenantId])
  @@index([warehouseId])
  @@index([status])
  @@index([date])
  @@index([referenceType, referenceId])
  @@map("gate_passes")
}

model GatePassItem {
  id          String   @id @default(cuid())
  gatePassId  String
  productId   String
  batchNo     String?
  binLocation String?
  quantity    Int
  description String?  @db.Text

  createdAt   DateTime @default(now())
  tenantId    String

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  gatePass    GatePass @relation(fields: [gatePassId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([gatePassId])
  @@index([productId])
  @@map("gate_pass_items")
}

// ============================================================================
// INVENTORY & STOCK MOVEMENTS (Story 2.6)
// ============================================================================

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  productVariantId String?
  warehouseId String
  quantity    Int      @default(0)
  batchNo     String?
  binLocation String?
  expiryDate  DateTime?  // Story 6.7

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    String

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])

  @@unique([productId, productVariantId, warehouseId, batchNo])
  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@index([productVariantId])
  @@map("inventory")
}

enum MovementType {
  RECEIPT
  SALE
  DELIVERY
  ADJUSTMENT
  TRANSFER
  SALES_RETURN
}

enum ReferenceType {
  PO
  INVOICE
  SALES_ORDER
  DELIVERY_NOTE
  PURCHASE_INVOICE
  ADJUSTMENT
  TRANSFER
  CREDIT_NOTE
  DEBIT_NOTE
}

model StockMovement {
  id            String         @id @default(cuid())
  productId     String
  productVariantId String?
  warehouseId   String
  movementType  MovementType
  quantity      Int
  referenceType ReferenceType?
  referenceId   String?
  movementDate  DateTime       @default(now())
  userId        String
  notes         String?        @db.Text

  createdAt     DateTime       @default(now())
  tenantId      String

  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  product         Product          @relation(fields: [productId], references: [id])
  productVariant  ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  user            User             @relation(fields: [userId], references: [id])
  stockAdjustment StockAdjustment?

  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@index([movementDate])
  @@index([referenceType, referenceId])
  @@index([productVariantId])
  @@map("stock_movements")
}

// ============================================================================
// STOCK ADJUSTMENTS (Story 2.8)
// ============================================================================

enum AdjustmentType {
  WASTAGE
  DAMAGE
  THEFT
  CORRECTION
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

model StockAdjustment {
  id               String           @id @default(cuid())
  productId        String
  productVariantId String?
  warehouseId      String
  adjustmentType   AdjustmentType
  quantity         Int              // Can be positive or negative
  reason           String           @db.Text
  notes            String?          @db.Text
  status           AdjustmentStatus @default(PENDING)

  // Workflow tracking
  createdBy        String
  createdAt        DateTime         @default(now())
  reviewedBy       String?
  reviewedAt       DateTime?
  rejectionReason  String?          @db.Text

  // Link to stock movement (created on approval)
  stockMovementId  String?          @unique

  tenantId         String

  // Relations
  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse        Warehouse        @relation(fields: [warehouseId], references: [id])
  creator          User             @relation("AdjustmentCreator", fields: [createdBy], references: [id])
  reviewer         User?            @relation("AdjustmentReviewer", fields: [reviewedBy], references: [id])
  stockMovement    StockMovement?   @relation(fields: [stockMovementId], references: [id])

  @@index([tenantId])
  @@index([productId])
  @@index([warehouseId])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@index([productVariantId])
  @@map("stock_adjustments")
}

// ============================================================================
// PRODUCT MANAGEMENT (Epic 2.4)
// ============================================================================

enum ProductStatus {
  ACTIVE
  INACTIVE
}

model Product {
  id            String         @id @default(cuid())
  sku           String
  name          String

  // Foreign keys to reference tables
  categoryId    String?
  brandId       String?
  uomId         String?

  // Variant support flag
  hasVariants   Boolean        @default(false)

  // Base pricing (used when hasVariants=false, or as fallback)
  costPrice     Decimal        @db.Decimal(10, 4)
  sellingPrice  Decimal        @db.Decimal(10, 4)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        ProductStatus  @default(ACTIVE)

  // Batch/Expiry tracking (Story 6.7)
  hasExpiry     Boolean        @default(false)
  shelfLifeDays Int?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?
  tenantId      String

  // Relations
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  brand         Brand?           @relation(fields: [brandId], references: [id])
  uom           UnitOfMeasure?   @relation(fields: [uomId], references: [id])
  variants         ProductVariant[]
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]
  creditNoteItems  CreditNoteItem[]   // Story 3.9
  gatePassItems    GatePassItem[]     // Epic 6
  stockTransferItems StockTransferItem[] // Story 6.4
  stockCountItems    StockCountItem[]    // Story 6.9
  goodsReceiveNoteItems GoodsReceiveNoteItem[] // GRN
  salesOrderItems       SalesOrderItem[]       // Epic 10
  deliveryNoteItems     DeliveryNoteItem[]     // Epic 10
  purchaseInvoiceItems  PurchaseInvoiceItem[]  // Epic 10

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([status])
  @@index([sku])
  @@index([categoryId])
  @@index([brandId])
  @@index([uomId])
  @@index([hasVariants])
  @@map("products")
}

// ============================================================================
// PURCHASE ORDER MANAGEMENT (Epic 2.2)
// ============================================================================

enum POStatus {
  PENDING
  IN_TRANSIT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum GRNStatus {
  COMPLETED
  CANCELLED
}

model PurchaseOrder {
  id                  String   @id @default(cuid())
  poNumber            String
  supplierId          String
  orderDate           DateTime
  expectedArrivalDate DateTime?
  status              POStatus @default(PENDING)
  taxRate             Decimal  @db.Decimal(7, 4) @default(0)
  taxAmount           Decimal  @db.Decimal(12, 4) @default(0)
  totalAmount         Decimal  @db.Decimal(12, 4)
  notes               String?  @db.Text

  // Import documentation fields (Story 2.3)
  containerNo         String?
  shipDate            DateTime?
  arrivalDate         DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  tenantId            String

  tenant              Tenant   @relation(fields: [tenantId], references: [id])
  supplier            Supplier @relation(fields: [supplierId], references: [id])
  items               POItem[]
  costs               POCost[] // Story 2.3: Additional costs
  goodsReceiveNotes   GoodsReceiveNote[]
  purchaseInvoices    PurchaseInvoice[]  // Epic 10

  @@unique([tenantId, poNumber])
  @@index([tenantId])
  @@index([status])
  @@index([supplierId])
  @@index([orderDate])
  @@map("purchase_orders")
}

// ============================================================================
// PO ADDITIONAL COSTS (Story 2.3)
// ============================================================================

enum POCostType {
  SHIPPING
  CUSTOMS
  TAX
  OTHER
}

model POCost {
  id            String      @id @default(cuid())
  poId          String
  type          POCostType
  amount        Decimal     @db.Decimal(10, 4)
  description   String?     @db.Text

  createdAt     DateTime    @default(now())
  createdBy     String?
  tenantId      String

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([poId])
  @@map("po_costs")
}

// ============================================================================
// PRODUCT VARIANTS (Epic 2.4.1)
// ============================================================================

enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id            String         @id @default(cuid())
  productId     String
  sku           String         // Variant-specific SKU (e.g., PROD-2025-001-RED-M)
  variantName   String         // e.g., "Red / Medium", "250mm / Chrome"

  // Variant attributes stored as JSON for flexibility
  // Example: {"color": "Red", "size": "Medium"} or {"length": "250mm", "finish": "Chrome"}
  attributes    Json

  // Variant-specific pricing (overrides base product pricing)
  costPrice     Decimal        @db.Decimal(10, 4)
  sellingPrice  Decimal        @db.Decimal(10, 4)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        VariantStatus  @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?
  tenantId      String

  // Relations
  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  product          Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]
  creditNoteItems  CreditNoteItem[]   // Story 3.9
  goodsReceiveNoteItems GoodsReceiveNoteItem[] // GRN
  salesOrderItems       SalesOrderItem[]       // Epic 10
  deliveryNoteItems     DeliveryNoteItem[]     // Epic 10
  purchaseInvoiceItems  PurchaseInvoiceItem[]  // Epic 10

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([productId])
  @@index([sku])
  @@index([status])
  @@map("product_variants")
}

model POItem {
  id               String          @id @default(cuid())
  poId             String
  productId        String
  productVariantId String?        // Optional: references specific variant
  quantity         Int
  receivedQuantity Int            @default(0)
  unitCost         Decimal         @db.Decimal(10, 4)
  totalCost        Decimal         @db.Decimal(12, 4)

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdBy        String?
  updatedBy        String?
  tenantId         String

  tenant           Tenant          @relation(fields: [tenantId], references: [id])
  purchaseOrder    PurchaseOrder   @relation(fields: [poId], references: [id], onDelete: Cascade)
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  goodsReceiveNoteItems GoodsReceiveNoteItem[]

  @@index([tenantId])
  @@index([poId])
  @@index([productId])
  @@index([productVariantId])
  @@map("po_items")
}

// ============================================================================
// GOODS RECEIVE NOTES (GRN)
// ============================================================================

model GoodsReceiveNote {
  id            String    @id @default(cuid())
  grnNumber     String
  poId          String
  warehouseId   String
  receivedDate  DateTime  @default(now())
  status        GRNStatus @default(COMPLETED)
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String
  tenantId      String

  tenant        Tenant          @relation(fields: [tenantId], references: [id])
  purchaseOrder PurchaseOrder   @relation(fields: [poId], references: [id])
  warehouse     Warehouse       @relation(fields: [warehouseId], references: [id])
  creator       User            @relation("CreatedGRNs", fields: [createdBy], references: [id])
  items            GoodsReceiveNoteItem[]
  costs            GRNCost[]
  purchaseInvoices PurchaseInvoice[]  // Epic 10

  @@unique([tenantId, grnNumber])
  @@index([tenantId])
  @@index([poId])
  @@index([warehouseId])
  @@index([status])
  @@map("goods_receive_notes")
}

model GoodsReceiveNoteItem {
  id               String  @id @default(cuid())
  grnId            String
  poItemId         String
  productId        String
  productVariantId String?
  quantity         Int
  binLocation      String?
  batchNo          String?
  tenantId         String

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  grn              GoodsReceiveNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItem           POItem           @relation(fields: [poItemId], references: [id])
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])

  @@index([tenantId])
  @@index([grnId])
  @@index([poItemId])
  @@map("goods_receive_note_items")
}

model GRNCost {
  id          String     @id @default(cuid())
  grnId       String
  type        POCostType
  amount      Decimal    @db.Decimal(10, 4)
  description String?    @db.Text
  createdAt   DateTime   @default(now())
  createdBy   String?
  tenantId    String

  tenant Tenant           @relation(fields: [tenantId], references: [id])
  grn    GoodsReceiveNote @relation(fields: [grnId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([grnId])
  @@map("grn_costs")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  roleId       String
  status       String    @default("active") // active, inactive
  lastLoginAt  DateTime?
  tenantId     String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant              Tenant            @relation(fields: [tenantId], references: [id])
  role                Role              @relation(fields: [roleId], references: [id])
  auditLogs           AuditLog[]
  stockMovements      StockMovement[]
  createdAdjustments  StockAdjustment[] @relation("AdjustmentCreator")
  reviewedAdjustments StockAdjustment[] @relation("AdjustmentReviewer")
  payments            Payment[]         @relation("PaymentRecorder")
  voidedInvoices      Invoice[]         @relation("VoidedInvoices")  // Story 3.4
  expenses            Expense[]         // Story 3.7
  creditNotesCreated  CreditNote[]      @relation("CreditNoteCreator") // Story 3.9
  journalEntriesCreated  JournalEntry[]  @relation("JournalEntryCreator")   // Epic 5
  journalEntriesApproved JournalEntry[]  @relation("JournalEntryApprover")  // Epic 5
  bankReconciliations    BankReconciliation[] @relation("BankReconciler")    // Epic 5
  periodCloses           PeriodClose[]   @relation("PeriodCloser")          // Epic 5
  issuedGatePasses       GatePass[]      @relation("IssuedGatePasses")      // Epic 6
  approvedGatePasses     GatePass[]      @relation("ApprovedGatePasses")    // Epic 6
  requestedTransfers     StockTransfer[] @relation("TransferRequester")     // Story 6.4
  approvedTransfers      StockTransfer[] @relation("TransferApprover")      // Story 6.4
  createdStockCounts     StockCount[]    @relation("StockCountCreator")     // Story 6.9
  createdGRNs            GoodsReceiveNote[] @relation("CreatedGRNs")        // GRN
  recoveryClients        Client[]        @relation("RecoveryAgentClients")  // Epic 7
  recoveryVisits         RecoveryVisit[] @relation("RecoveryVisits")        // Epic 7
  createdPromises        PaymentPromise[] @relation("CreatedPromises")      // Epic 7
  alertsReceived         Alert[]         @relation("AlertTargetUser")       // Epic 7
  alertsAcknowledged     Alert[]         @relation("AlertAcknowledger")     // Epic 7
  changeHistory          ChangeHistory[]                                    // Epic 8
  salesOrdersCreated     SalesOrder[]    @relation("SalesOrderCreator")            // Epic 10
  deliveryNotesCreated   DeliveryNote[]  @relation("DeliveryNoteCreator")          // Epic 10
  deliveryNotesDispatched DeliveryNote[] @relation("DeliveryNoteDispatcher")       // Epic 10
  deliveryNotesCompleted DeliveryNote[]  @relation("DeliveryNoteCompleter")        // Epic 10
  purchaseInvoicesCreated PurchaseInvoice[] @relation("PurchaseInvoiceCreator")    // Epic 10

  @@index([email])
  @@index([roleId])
  @@index([status])
  @@index([tenantId])
  @@map("users")
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  action        String   // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
  entityType    String   // User, Product, Invoice, Payment, etc.
  entityId      String?
  timestamp     DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  changedFields Json?    // { field: { old: value, new: value } }
  notes         String?  @db.Text
  tenantId      String

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
  @@index([action])
  @@index([tenantId])
  @@map("audit_logs")
}

// ============================================================================
// CHANGE HISTORY (Epic 8.2 â€” Version Comparison)
// ============================================================================

model ChangeHistory {
  id           String   @id @default(cuid())
  entityType   String   // PRODUCT, CLIENT, SUPPLIER, PURCHASE_ORDER, INVOICE, PAYMENT
  entityId     String
  version      Int
  changedBy    String?
  changedAt    DateTime @default(now())
  snapshot     Json     // Whitelisted fields snapshot at time of change
  changeReason String?  @db.Text
  tenantId     String

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [changedBy], references: [id])

  @@unique([tenantId, entityType, entityId, version])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("change_history")
}

// ============================================================================
// PAYMENT TRACKING (Epic 2.10)
// ============================================================================

enum PaymentType {
  SUPPLIER
  CLIENT
}

enum PaymentReferenceType {
  PO
  INVOICE
  PURCHASE_INVOICE
  GENERAL
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
}

model Payment {
  id                   String                 @id @default(cuid())
  supplierId           String?
  clientId             String?                // Story 3.6: Client payment support
  paymentType          PaymentType
  paymentReferenceType PaymentReferenceType?
  referenceId          String?                // PO ID or Invoice ID (deprecated for client payments, use allocations)
  amount               Decimal                @db.Decimal(12, 4)
  method               PaymentMethod
  referenceNumber      String?                // Story 3.6: Cheque/Bank transfer reference
  date                 DateTime
  notes                String?                @db.Text
  recordedBy           String
  bankAccountId        String?                // Epic 5: Link to bank account head

  createdAt            DateTime               @default(now())

  tenantId             String

  tenant               Tenant                 @relation(fields: [tenantId], references: [id])
  supplier             Supplier?              @relation(fields: [supplierId], references: [id])
  client               Client?                @relation(fields: [clientId], references: [id])
  user                 User                   @relation("PaymentRecorder", fields: [recordedBy], references: [id])
  bankAccount          AccountHead?           @relation("PaymentBankAccount", fields: [bankAccountId], references: [id])
  allocations          PaymentAllocation[]    // Story 3.6: Payment allocation to invoices

  @@index([tenantId])
  @@index([paymentType, paymentReferenceType, referenceId])
  @@index([supplierId])
  @@index([clientId])
  @@index([date])
  @@index([bankAccountId])
  @@map("payments")
}

// Story 3.6: Payment Allocation for Invoice Payments
model PaymentAllocation {
  id        String   @id @default(cuid())
  paymentId String
  invoiceId String
  amount    Decimal  @db.Decimal(12, 4)
  createdAt DateTime @default(now())
  tenantId  String

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([paymentId])
  @@index([invoiceId])
  @@map("payment_allocations")
}

// ============================================================================
// CLIENT MANAGEMENT (Epic 3.1)
// ============================================================================

enum ClientStatus {
  ACTIVE
  INACTIVE
}

model Client {
  id              String       @id @default(cuid())
  name            String
  contactPerson   String?
  phone           String?
  whatsapp        String?
  email           String?
  city            String?
  area            String?
  creditLimit     Decimal      @db.Decimal(12, 4) @default(0)
  paymentTermsDays Int         @default(30)
  balance         Decimal      @db.Decimal(12, 4) @default(0)
  status          ClientStatus @default(ACTIVE)

  // Tax exemption (Story 3.5)
  taxExempt       Boolean      @default(false)
  taxExemptReason String?      @db.Text

  // Recovery management (Epic 7)
  recoveryDay       RecoveryDay? @default(NONE)
  recoveryAgentId   String?

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  tenantId        String

  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  invoices        Invoice[]
  payments        Payment[]            // Story 3.6: Client payments
  creditNotes     CreditNote[]         // Story 3.9: Credit notes
  recoveryAgent   User?                @relation("RecoveryAgentClients", fields: [recoveryAgentId], references: [id])
  recoveryVisits  RecoveryVisit[]      // Epic 7
  paymentPromises PaymentPromise[]     // Epic 7
  salesOrders     SalesOrder[]         // Epic 10
  deliveryNotes   DeliveryNote[]       // Epic 10

  @@index([tenantId])
  @@index([recoveryAgentId])
  @@map("clients")
}

// ============================================================================
// SYSTEM SETTINGS (Story 3.2)
// ============================================================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   // e.g., "TAX_RATE", "CURRENCY", "BUSINESS_NAME"
  value     String   @db.Text
  dataType  String   // "number", "string", "boolean"
  label     String   // Human-readable label
  category  String?  // "tax", "general", "invoice", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String

  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([category])
  @@map("system_settings")
}

// ============================================================================
// SALES INVOICES (Story 3.2)
// ============================================================================

enum InvoiceStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  VOIDED  // Story 3.4: Invoice voiding
}

enum InvoicePaymentType {
  CASH
  CREDIT
}

model Invoice {
  id             String               @id @default(cuid())
  invoiceNumber  String
  clientId       String
  warehouseId    String
  salesOrderId   String?              // Epic 10: Link to SO
  deliveryNoteId String?              // Epic 10: Link to DN
  invoiceDate    DateTime
  dueDate        DateTime
  paymentType    InvoicePaymentType
  subtotal       Decimal              @db.Decimal(12, 4)
  taxAmount      Decimal              @db.Decimal(12, 4)
  taxRate        Decimal              @db.Decimal(7, 4) @default(0) // Snapshot of tax rate at creation (Story 3.5)
  total          Decimal              @db.Decimal(12, 4)
  paidAmount     Decimal              @db.Decimal(12, 4) @default(0)
  status         InvoiceStatus        @default(PENDING)
  notes          String?              @db.Text

  // Story 3.4: Void tracking
  voidedAt      DateTime?
  voidedBy      String?
  voidReason    String?              @db.Text

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  tenantId      String

  tenant        Tenant               @relation(fields: [tenantId], references: [id])
  client        Client               @relation(fields: [clientId], references: [id])
  warehouse     Warehouse            @relation(fields: [warehouseId], references: [id])
  voider        User?                @relation("VoidedInvoices", fields: [voidedBy], references: [id])
  salesOrder    SalesOrder?          @relation(fields: [salesOrderId], references: [id])    // Epic 10
  deliveryNote  DeliveryNote?        @relation(fields: [deliveryNoteId], references: [id])  // Epic 10
  items         InvoiceItem[]
  allocations   PaymentAllocation[]  // Story 3.6: Payment allocations
  creditNotes   CreditNote[]         // Story 3.9: Credit notes / sales returns

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([warehouseId])
  @@index([status])
  @@index([invoiceDate])
  @@map("invoices")
}

model InvoiceItem {
  id               String          @id @default(cuid())
  invoiceId        String
  productId        String
  productVariantId String?
  batchNo          String?
  quantity         Int
  unitPrice        Decimal         @db.Decimal(10, 4)
  discount         Decimal         @db.Decimal(7, 4) @default(0)
  total            Decimal         @db.Decimal(12, 4)
  tenantId         String

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  invoice          Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])
  creditNoteItems  CreditNoteItem[] // Story 3.9: Credit note line items

  @@index([tenantId])
  @@index([invoiceId])
  @@index([productId])
  @@index([productVariantId])
  @@map("invoice_items")
}

// ============================================================================
// EXPENSE TRACKING (Story 3.7)
// ============================================================================

enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  SUPPLIES
  MAINTENANCE
  MARKETING
  TRANSPORT
  MISC
}

model Expense {
  id            String          @id @default(cuid())
  category      ExpenseCategory
  amount        Decimal         @db.Decimal(12, 4)
  description   String          @db.Text
  date          DateTime
  paymentMethod PaymentMethod
  receiptUrl    String?         @db.Text
  recordedBy    String

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tenantId      String

  tenant        Tenant          @relation(fields: [tenantId], references: [id])
  user          User            @relation(fields: [recordedBy], references: [id])

  @@index([tenantId])
  @@index([category])
  @@index([date])
  @@index([recordedBy])
  @@map("expenses")
}

// ============================================================================
// CREDIT NOTES / SALES RETURNS (Story 3.9)
// ============================================================================

enum CreditNoteStatus {
  OPEN
  APPLIED
  VOIDED
}

model CreditNote {
  id               String           @id @default(cuid())
  creditNoteNumber String
  invoiceId        String
  clientId         String
  reason           String           @db.Text
  subtotal         Decimal          @db.Decimal(12, 4)
  taxRate          Decimal          @db.Decimal(7, 4)  @default(0)
  taxAmount        Decimal          @db.Decimal(12, 4)
  totalAmount      Decimal          @db.Decimal(12, 4)
  status           CreditNoteStatus @default(OPEN)
  createdBy        String

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  tenantId         String

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  invoice          Invoice          @relation(fields: [invoiceId], references: [id])
  client           Client           @relation(fields: [clientId], references: [id])
  creator          User             @relation("CreditNoteCreator", fields: [createdBy], references: [id])
  items            CreditNoteItem[]

  @@unique([tenantId, creditNoteNumber])
  @@index([tenantId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("credit_notes")
}

model CreditNoteItem {
  id               String          @id @default(cuid())
  creditNoteId     String
  invoiceItemId    String
  productId        String
  productVariantId String?
  batchNo          String?
  quantityReturned Int
  unitPrice        Decimal         @db.Decimal(10, 4)
  discount         Decimal         @db.Decimal(7, 4)  @default(0)
  total            Decimal         @db.Decimal(12, 4)

  createdAt        DateTime        @default(now())

  tenantId         String

  tenant           Tenant          @relation(fields: [tenantId], references: [id])
  creditNote       CreditNote      @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  invoiceItem      InvoiceItem     @relation(fields: [invoiceItemId], references: [id])
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([tenantId])
  @@index([creditNoteId])
  @@index([invoiceItemId])
  @@index([productId])
  @@index([productVariantId])
  @@map("credit_note_items")
}

// ============================================================================
// ACCOUNTING - GENERAL LEDGER (Epic 5)
// ============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountStatus {
  ACTIVE
  INACTIVE
}

enum JournalEntryStatus {
  DRAFT
  POSTED
}

enum ReconciliationStatus {
  IN_PROGRESS
  COMPLETED
}

enum PeriodType {
  MONTH
  YEAR
}

enum PeriodCloseStatus {
  CLOSED
  REOPENED
}

model AccountHead {
  id              String        @id @default(cuid())
  code            String
  name            String
  accountType     AccountType
  parentId        String?
  openingBalance  Decimal       @db.Decimal(14, 4) @default(0)
  currentBalance  Decimal       @db.Decimal(14, 4) @default(0)
  status          AccountStatus @default(ACTIVE)
  isSystemAccount Boolean       @default(false)
  description     String?       @db.Text

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  tenantId        String

  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  parent          AccountHead?  @relation("AccountHeadHierarchy", fields: [parentId], references: [id])
  children        AccountHead[] @relation("AccountHeadHierarchy")
  journalLines    JournalEntryLine[]
  bankReconciliations BankReconciliation[]
  payments        Payment[]     @relation("PaymentBankAccount")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([accountType])
  @@index([parentId])
  @@index([status])
  @@map("account_heads")
}

model JournalEntry {
  id              String             @id @default(cuid())
  entryNumber     String
  date            DateTime
  description     String             @db.Text
  status          JournalEntryStatus @default(DRAFT)
  referenceType   String?
  referenceId     String?
  createdBy       String
  approvedBy      String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  tenantId        String

  tenant          Tenant             @relation(fields: [tenantId], references: [id])
  creator         User               @relation("JournalEntryCreator", fields: [createdBy], references: [id])
  approver        User?              @relation("JournalEntryApprover", fields: [approvedBy], references: [id])
  lines           JournalEntryLine[]
  closingPeriods  PeriodClose[]      @relation("ClosingJournalEntry")

  @@unique([tenantId, entryNumber])
  @@index([tenantId])
  @@index([status])
  @@index([date])
  @@index([referenceType, referenceId])
  @@index([createdBy])
  @@map("journal_entries")
}

model JournalEntryLine {
  id              String        @id @default(cuid())
  journalEntryId  String
  accountHeadId   String
  debitAmount     Decimal       @db.Decimal(14, 4) @default(0)
  creditAmount    Decimal       @db.Decimal(14, 4) @default(0)
  description     String?       @db.Text

  createdAt       DateTime      @default(now())
  tenantId        String

  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])
  reconciliationItems BankReconciliationItem[]

  @@index([tenantId])
  @@index([journalEntryId])
  @@index([accountHeadId])
  @@map("journal_entry_lines")
}

model BankReconciliation {
  id               String               @id @default(cuid())
  bankAccountId    String
  statementDate    DateTime
  statementBalance Decimal              @db.Decimal(14, 4)
  systemBalance    Decimal              @db.Decimal(14, 4)
  status           ReconciliationStatus @default(IN_PROGRESS)
  reconciledBy     String

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  tenantId         String

  tenant           Tenant               @relation(fields: [tenantId], references: [id])
  bankAccount      AccountHead          @relation(fields: [bankAccountId], references: [id])
  reconciler       User                 @relation("BankReconciler", fields: [reconciledBy], references: [id])
  items            BankReconciliationItem[]

  @@index([tenantId])
  @@index([bankAccountId])
  @@index([status])
  @@map("bank_reconciliations")
}

model BankReconciliationItem {
  id                  String             @id @default(cuid())
  reconciliationId    String
  journalEntryLineId  String?
  description         String             @db.Text
  statementAmount     Decimal            @db.Decimal(14, 4)
  statementDate       DateTime
  matched             Boolean            @default(false)
  notes               String?            @db.Text

  createdAt           DateTime           @default(now())

  tenantId            String

  tenant              Tenant             @relation(fields: [tenantId], references: [id])
  reconciliation      BankReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  journalEntryLine    JournalEntryLine?  @relation(fields: [journalEntryLineId], references: [id])

  @@index([tenantId])
  @@index([reconciliationId])
  @@index([journalEntryLineId])
  @@map("bank_reconciliation_items")
}

model PeriodClose {
  id                    String           @id @default(cuid())
  periodType            PeriodType
  periodDate            DateTime
  netProfit             Decimal          @db.Decimal(14, 4)
  status                PeriodCloseStatus @default(CLOSED)
  closedBy              String
  closingJournalEntryId String?
  reopenReason          String?          @db.Text

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  tenantId              String

  tenant                Tenant           @relation(fields: [tenantId], references: [id])
  closer                User             @relation("PeriodCloser", fields: [closedBy], references: [id])
  closingJournalEntry   JournalEntry?    @relation("ClosingJournalEntry", fields: [closingJournalEntryId], references: [id])

  @@unique([tenantId, periodType, periodDate])
  @@index([tenantId])
  @@index([status])
  @@map("period_closes")
}

// ============================================================================
// STOCK TRANSFERS (Story 6.4)
// ============================================================================

enum TransferStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

model StockTransfer {
  id                     String         @id @default(cuid())
  transferNumber         String
  sourceWarehouseId      String
  destinationWarehouseId String
  status                 TransferStatus @default(PENDING)
  requestedBy            String
  approvedBy             String?
  dispatchedBy           String?
  completedBy            String?
  notes                  String?        @db.Text

  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  tenantId               String

  tenant                 Tenant         @relation(fields: [tenantId], references: [id])
  sourceWarehouse        Warehouse      @relation("TransferSource", fields: [sourceWarehouseId], references: [id])
  destinationWarehouse   Warehouse      @relation("TransferDestination", fields: [destinationWarehouseId], references: [id])
  requester              User           @relation("TransferRequester", fields: [requestedBy], references: [id])
  approver               User?          @relation("TransferApprover", fields: [approvedBy], references: [id])
  items                  StockTransferItem[]

  @@unique([tenantId, transferNumber])
  @@index([tenantId])
  @@index([sourceWarehouseId])
  @@index([destinationWarehouseId])
  @@index([status])
  @@index([createdAt])
  @@map("stock_transfers")
}

model StockTransferItem {
  id               String        @id @default(cuid())
  stockTransferId  String
  productId        String
  batchNo          String?
  quantity         Int
  receivedQuantity Int?
  notes            String?       @db.Text

  createdAt        DateTime      @default(now())
  tenantId         String

  tenant           Tenant        @relation(fields: [tenantId], references: [id])
  stockTransfer    StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)
  product          Product       @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([stockTransferId])
  @@index([productId])
  @@map("stock_transfer_items")
}

// ============================================================================
// BIN LOCATIONS (Story 6.5)
// ============================================================================

model BinLocation {
  id          String   @id @default(cuid())
  warehouseId String
  code        String
  zone        String?
  description String?  @db.Text
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenantId    String

  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([tenantId, warehouseId, code])
  @@index([tenantId])
  @@index([warehouseId])
  @@map("bin_locations")
}

// ============================================================================
// PHYSICAL STOCK COUNTS (Story 6.9)
// ============================================================================

enum CountStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model StockCount {
  id          String      @id @default(cuid())
  countNumber String
  warehouseId String
  status      CountStatus @default(PLANNED)
  countDate   DateTime
  notes       String?     @db.Text
  createdBy   String
  completedBy String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenantId    String

  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  warehouse   Warehouse   @relation(fields: [warehouseId], references: [id])
  creator     User        @relation("StockCountCreator", fields: [createdBy], references: [id])
  items       StockCountItem[]

  @@unique([tenantId, countNumber])
  @@index([tenantId])
  @@index([warehouseId])
  @@index([status])
  @@index([countDate])
  @@map("stock_counts")
}

model StockCountItem {
  id             String    @id @default(cuid())
  stockCountId   String
  productId      String
  batchNo        String?
  binLocation    String?
  systemQuantity Int
  countedQuantity Int?
  variance       Int?
  notes          String?   @db.Text

  createdAt      DateTime  @default(now())
  tenantId       String

  tenant         Tenant     @relation(fields: [tenantId], references: [id])
  stockCount     StockCount @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  product        Product    @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([stockCountId])
  @@index([productId])
  @@map("stock_count_items")
}

// ============================================================================
// RECOVERY & COLLECTION MANAGEMENT (Epic 7)
// ============================================================================

enum RecoveryDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  NONE
}

enum VisitOutcome {
  PAYMENT_COLLECTED
  PROMISE_MADE
  CLIENT_UNAVAILABLE
  REFUSED_TO_PAY
  PARTIAL_PAYMENT
  DISPUTE_RAISED
  OTHER
}

enum PromiseStatus {
  PENDING
  FULFILLED
  PARTIAL
  BROKEN
  CANCELLED
}

enum AlertType {
  CLIENT_OVERDUE
  PROMISE_BROKEN
  STOCK_LOW
  EXPIRY_WARNING
  CREDIT_LIMIT_EXCEEDED
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertAction {
  NOTIFY
  EMAIL
  SMS
}

model RecoveryVisit {
  id              String       @id @default(cuid())
  visitNumber     String
  clientId        String
  visitDate       DateTime
  visitTime       String?
  outcome         VisitOutcome
  amountCollected Decimal      @db.Decimal(12, 4) @default(0)
  promiseDate     DateTime?
  promiseAmount   Decimal?     @db.Decimal(12, 4)
  notes           String?      @db.Text
  visitedBy       String
  latitude        Float?
  longitude       Float?

  createdAt       DateTime     @default(now())
  tenantId        String

  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  client          Client       @relation(fields: [clientId], references: [id])
  visitor         User         @relation("RecoveryVisits", fields: [visitedBy], references: [id])
  paymentPromise  PaymentPromise?

  @@unique([tenantId, visitNumber])
  @@index([tenantId])
  @@index([clientId, visitDate])
  @@index([visitedBy])
  @@map("recovery_visits")
}

model PaymentPromise {
  id                String        @id @default(cuid())
  clientId          String
  promiseDate       DateTime
  promiseAmount     Decimal       @db.Decimal(12, 4)
  actualPaymentDate DateTime?
  actualAmount      Decimal?      @db.Decimal(12, 4)
  status            PromiseStatus @default(PENDING)
  recoveryVisitId   String?       @unique
  notes             String?       @db.Text
  createdBy         String

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  tenantId          String

  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  client            Client        @relation(fields: [clientId], references: [id])
  recoveryVisit     RecoveryVisit? @relation(fields: [recoveryVisitId], references: [id])
  creator           User          @relation("CreatedPromises", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([clientId, status])
  @@index([promiseDate, status])
  @@map("payment_promises")
}

model AlertRule {
  id          String        @id @default(cuid())
  name        String
  daysOverdue Int
  priority    AlertPriority
  targetRoles Json
  action      AlertAction
  isActive    Boolean       @default(true)

  createdAt   DateTime      @default(now())
  tenantId    String

  tenant      Tenant        @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("alert_rules")
}

model Alert {
  id              String        @id @default(cuid())
  type            AlertType
  priority        AlertPriority
  message         String        @db.Text
  relatedType     String?
  relatedId       String?
  targetUserId    String?
  targetRole      String?
  acknowledged    Boolean       @default(false)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  expiresAt       DateTime?

  createdAt       DateTime      @default(now())

  tenantId        String

  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  targetUser      User?         @relation("AlertTargetUser", fields: [targetUserId], references: [id])
  acknowledger    User?         @relation("AlertAcknowledger", fields: [acknowledgedBy], references: [id])

  @@index([tenantId])
  @@index([targetUserId, acknowledged])
  @@index([type, relatedId])
  @@index([targetRole, acknowledged])
  @@map("alerts")
}

// ============================================================================
// SALES ORDERS (Epic 10 - Story 10.1)
// ============================================================================

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  PARTIALLY_DELIVERED
  DELIVERED
  PARTIALLY_INVOICED
  INVOICED
  CANCELLED
  CLOSED
}

model SalesOrder {
  id                   String           @id @default(cuid())
  orderNumber          String
  clientId             String
  warehouseId          String
  orderDate            DateTime         @default(now())
  expectedDeliveryDate DateTime?
  paymentType          PaymentType
  subtotal             Decimal          @db.Decimal(14, 4)
  taxRate              Decimal          @db.Decimal(5, 4)
  taxAmount            Decimal          @db.Decimal(14, 4)
  total                Decimal          @db.Decimal(14, 4)
  status               SalesOrderStatus @default(DRAFT)
  notes                String?          @db.Text
  createdBy            String
  updatedBy            String?
  cancelReason         String?          @db.Text
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  tenantId             String

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  client        Client    @relation(fields: [clientId], references: [id])
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id])
  creator       User      @relation("SalesOrderCreator", fields: [createdBy], references: [id])
  items         SalesOrderItem[]
  deliveryNotes DeliveryNote[]
  invoices      Invoice[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@map("sales_orders")
}

model SalesOrderItem {
  id                String  @id @default(cuid())
  salesOrderId      String
  productId         String
  productVariantId  String?
  quantity          Int
  deliveredQuantity Int     @default(0)
  invoicedQuantity  Int     @default(0)
  unitPrice         Decimal @db.Decimal(14, 4)
  discount          Decimal @default(0) @db.Decimal(5, 2)
  total             Decimal @db.Decimal(14, 4)
  tenantId          String

  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  salesOrder        SalesOrder      @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  product           Product         @relation(fields: [productId], references: [id])
  productVariant    ProductVariant? @relation(fields: [productVariantId], references: [id])
  deliveryNoteItems DeliveryNoteItem[]

  @@index([tenantId])
  @@index([salesOrderId])
  @@map("sales_order_items")
}

// ============================================================================
// DELIVERY NOTES (Epic 10 - Story 10.1)
// ============================================================================

enum DeliveryNoteStatus {
  PENDING
  DISPATCHED
  DELIVERED
  CANCELLED
}

model DeliveryNote {
  id                 String             @id @default(cuid())
  deliveryNoteNumber String
  salesOrderId       String?
  clientId           String
  warehouseId        String
  deliveryDate       DateTime           @default(now())
  status             DeliveryNoteStatus @default(PENDING)
  deliveryAddress    String?            @db.Text
  driverName         String?
  vehicleNo          String?
  notes              String?            @db.Text
  createdBy          String
  dispatchedBy       String?
  completedBy        String?
  cancelReason       String?            @db.Text
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  tenantId           String

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  salesOrder SalesOrder? @relation(fields: [salesOrderId], references: [id])
  client     Client      @relation(fields: [clientId], references: [id])
  warehouse  Warehouse   @relation(fields: [warehouseId], references: [id])
  creator    User        @relation("DeliveryNoteCreator", fields: [createdBy], references: [id])
  dispatcher User?       @relation("DeliveryNoteDispatcher", fields: [dispatchedBy], references: [id])
  completer  User?       @relation("DeliveryNoteCompleter", fields: [completedBy], references: [id])
  items      DeliveryNoteItem[]
  invoices   Invoice[]

  @@unique([tenantId, deliveryNoteNumber])
  @@index([tenantId])
  @@index([clientId])
  @@index([salesOrderId])
  @@index([status])
  @@map("delivery_notes")
}

model DeliveryNoteItem {
  id               String  @id @default(cuid())
  deliveryNoteId   String
  salesOrderItemId String?
  productId        String
  productVariantId String?
  batchNo          String?
  quantity         Int
  tenantId         String

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  deliveryNote   DeliveryNote    @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  salesOrderItem SalesOrderItem? @relation(fields: [salesOrderItemId], references: [id])
  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([tenantId])
  @@index([deliveryNoteId])
  @@map("delivery_note_items")
}

// ============================================================================
// PURCHASE INVOICES (Epic 10 - Story 10.1)
// ============================================================================

enum PurchaseInvoiceStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

model PurchaseInvoice {
  id             String                @id @default(cuid())
  invoiceNumber  String                // Supplier's invoice # (manual entry)
  internalNumber String                // Auto: PI-YYYYMMDD-NNN
  supplierId     String
  poId           String?
  grnId          String?
  invoiceDate    DateTime
  dueDate        DateTime?
  subtotal       Decimal               @db.Decimal(14, 4)
  taxRate        Decimal               @db.Decimal(5, 4)
  taxAmount      Decimal               @db.Decimal(14, 4)
  total          Decimal               @db.Decimal(14, 4)
  paidAmount     Decimal               @default(0) @db.Decimal(14, 4)
  status         PurchaseInvoiceStatus @default(PENDING)
  notes          String?               @db.Text
  createdBy      String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  tenantId       String

  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  supplier         Supplier          @relation(fields: [supplierId], references: [id])
  purchaseOrder    PurchaseOrder?    @relation(fields: [poId], references: [id])
  goodsReceiveNote GoodsReceiveNote? @relation(fields: [grnId], references: [id])
  creator          User              @relation("PurchaseInvoiceCreator", fields: [createdBy], references: [id])
  items            PurchaseInvoiceItem[]

  @@unique([tenantId, internalNumber])
  @@index([tenantId])
  @@index([supplierId])
  @@index([poId])
  @@index([status])
  @@map("purchase_invoices")
}

model PurchaseInvoiceItem {
  id                String  @id @default(cuid())
  purchaseInvoiceId String
  productId         String
  productVariantId  String?
  quantity          Int
  unitCost          Decimal @db.Decimal(14, 4)
  total             Decimal @db.Decimal(14, 4)
  tenantId          String

  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([tenantId])
  @@index([purchaseInvoiceId])
  @@map("purchase_invoice_items")
}
