// Prisma Schema for Hisham Traders ERP

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// CORE TABLES (Epic 1)
// ============================================================================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // ADMIN, WAREHOUSE_MANAGER, SALES_OFFICER, ACCOUNTANT, RECOVERY_AGENT
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]

  @@map("roles")
}

// ============================================================================
// REFERENCE TABLES (Epic 2 - Lookup/Master Data)
// ============================================================================

model Country {
  id        String    @id @default(cuid())
  code      String    @unique  // "CN", "PK", "AE", "US", etc.
  name      String    @unique  // "China", "Pakistan", "UAE", "United States"
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  suppliers Supplier[]

  @@map("countries")
}

model PaymentTerm {
  id          String    @id @default(cuid())
  name        String    @unique  // "Net 30", "50% Advance + 50% on Delivery", etc.
  description String?   @db.Text
  days        Int?      // For calculating due dates (30, 60, etc.)
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  suppliers   Supplier[]

  @@map("payment_terms")
}

model ProductCategory {
  id          String    @id @default(cuid())
  name        String    @unique  // "Sinks", "Faucets", "Toilets", "Showers", "Accessories"
  description String?   @db.Text
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("product_categories")
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  country   String?   // Brand origin country (optional)
  active    Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products  Product[]

  @@map("brands")
}

model UnitOfMeasure {
  id           String    @id @default(cuid())
  name         String    @unique  // "Piece", "Box", "Case", etc.
  abbreviation String    @unique  // "pc", "box", "cs", etc.
  description  String?   @db.Text
  active       Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  products     Product[]

  @@map("units_of_measure")
}

// ============================================================================
// SUPPLIER MANAGEMENT (Epic 2.1)
// ============================================================================

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id            String         @id @default(cuid())
  name          String         @unique

  // Foreign keys to reference tables
  countryId     String?
  paymentTermId String?

  contactPerson String?
  email         String?        @unique
  phone         String?
  address       String?        @db.Text
  status        SupplierStatus @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  country       Country?           @relation(fields: [countryId], references: [id])
  paymentTerm   PaymentTerm?       @relation(fields: [paymentTermId], references: [id])
  purchaseOrders PurchaseOrder[]
  payments      Payment[]

  @@index([status])
  @@index([countryId])
  @@index([paymentTermId])
  @@map("suppliers")
}

// ============================================================================
// WAREHOUSE MANAGEMENT (Epic 2.5)
// ============================================================================

enum WarehouseStatus {
  ACTIVE
  INACTIVE
}

model Warehouse {
  id        String          @id @default(cuid())
  name      String          @unique
  location  String?         @db.Text  // Full address
  city      String?
  status    WarehouseStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoices         Invoice[]

  @@index([status])
  @@map("warehouses")
}

// ============================================================================
// INVENTORY & STOCK MOVEMENTS (Story 2.6)
// ============================================================================

model Inventory {
  id          String   @id @default(cuid())
  productId   String
  productVariantId String?
  warehouseId String
  quantity    Int      @default(0)
  batchNo     String?
  binLocation String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product        Product         @relation(fields: [productId], references: [id])
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
  warehouse      Warehouse       @relation(fields: [warehouseId], references: [id])

  @@unique([productId, productVariantId, warehouseId, batchNo])
  @@index([productId])
  @@index([warehouseId])
  @@index([productVariantId])
  @@map("inventory")
}

enum MovementType {
  RECEIPT
  SALE
  ADJUSTMENT
  TRANSFER
}

enum ReferenceType {
  PO
  INVOICE
  ADJUSTMENT
  TRANSFER
}

model StockMovement {
  id            String         @id @default(cuid())
  productId     String
  productVariantId String?
  warehouseId   String
  movementType  MovementType
  quantity      Int
  referenceType ReferenceType?
  referenceId   String?
  movementDate  DateTime       @default(now())
  userId        String
  notes         String?        @db.Text

  createdAt     DateTime       @default(now())

  product         Product          @relation(fields: [productId], references: [id])
  productVariant  ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id])
  user            User             @relation(fields: [userId], references: [id])
  stockAdjustment StockAdjustment?

  @@index([productId])
  @@index([warehouseId])
  @@index([movementDate])
  @@index([referenceType, referenceId])
  @@index([productVariantId])
  @@map("stock_movements")
}

// ============================================================================
// STOCK ADJUSTMENTS (Story 2.8)
// ============================================================================

enum AdjustmentType {
  WASTAGE
  DAMAGE
  THEFT
  CORRECTION
}

enum AdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
}

model StockAdjustment {
  id               String           @id @default(cuid())
  productId        String
  productVariantId String?
  warehouseId      String
  adjustmentType   AdjustmentType
  quantity         Int              // Can be positive or negative
  reason           String           @db.Text
  notes            String?          @db.Text
  status           AdjustmentStatus @default(PENDING)

  // Workflow tracking
  createdBy        String
  createdAt        DateTime         @default(now())
  reviewedBy       String?
  reviewedAt       DateTime?
  rejectionReason  String?          @db.Text

  // Link to stock movement (created on approval)
  stockMovementId  String?          @unique

  // Relations
  product          Product          @relation(fields: [productId], references: [id])
  productVariant   ProductVariant?  @relation(fields: [productVariantId], references: [id])
  warehouse        Warehouse        @relation(fields: [warehouseId], references: [id])
  creator          User             @relation("AdjustmentCreator", fields: [createdBy], references: [id])
  reviewer         User?            @relation("AdjustmentReviewer", fields: [reviewedBy], references: [id])
  stockMovement    StockMovement?   @relation(fields: [stockMovementId], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([status])
  @@index([createdBy])
  @@index([createdAt])
  @@index([productVariantId])
  @@map("stock_adjustments")
}

// ============================================================================
// PRODUCT MANAGEMENT (Epic 2.4)
// ============================================================================

enum ProductStatus {
  ACTIVE
  INACTIVE
}

model Product {
  id            String         @id @default(cuid())
  sku           String         @unique
  name          String

  // Foreign keys to reference tables
  categoryId    String?
  brandId       String?
  uomId         String?

  // Variant support flag
  hasVariants   Boolean        @default(false)

  // Base pricing (used when hasVariants=false, or as fallback)
  costPrice     Decimal        @db.Decimal(10, 2)
  sellingPrice  Decimal        @db.Decimal(10, 2)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        ProductStatus  @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  brand         Brand?           @relation(fields: [brandId], references: [id])
  uom           UnitOfMeasure?   @relation(fields: [uomId], references: [id])
  variants         ProductVariant[]
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]

  @@index([status])
  @@index([sku])
  @@index([categoryId])
  @@index([brandId])
  @@index([uomId])
  @@index([hasVariants])
  @@map("products")
}

// ============================================================================
// PURCHASE ORDER MANAGEMENT (Epic 2.2)
// ============================================================================

enum POStatus {
  PENDING
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id                  String   @id @default(cuid())
  poNumber            String   @unique
  supplierId          String
  orderDate           DateTime
  expectedArrivalDate DateTime?
  status              POStatus @default(PENDING)
  totalAmount         Decimal  @db.Decimal(12, 2)
  notes               String?  @db.Text

  // Import documentation fields (Story 2.3)
  containerNo         String?
  shipDate            DateTime?
  arrivalDate         DateTime?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?

  supplier            Supplier @relation(fields: [supplierId], references: [id])
  items               POItem[]
  costs               POCost[] // Story 2.3: Additional costs

  @@index([status])
  @@index([supplierId])
  @@index([orderDate])
  @@map("purchase_orders")
}

// ============================================================================
// PO ADDITIONAL COSTS (Story 2.3)
// ============================================================================

enum POCostType {
  SHIPPING
  CUSTOMS
  TAX
  OTHER
}

model POCost {
  id            String      @id @default(cuid())
  poId          String
  type          POCostType
  amount        Decimal     @db.Decimal(10, 2)
  description   String?     @db.Text

  createdAt     DateTime    @default(now())
  createdBy     String?

  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)

  @@index([poId])
  @@map("po_costs")
}

// ============================================================================
// PRODUCT VARIANTS (Epic 2.4.1)
// ============================================================================

enum VariantStatus {
  ACTIVE
  INACTIVE
}

model ProductVariant {
  id            String         @id @default(cuid())
  productId     String
  sku           String         @unique // Variant-specific SKU (e.g., PROD-2025-001-RED-M)
  variantName   String         // e.g., "Red / Medium", "250mm / Chrome"

  // Variant attributes stored as JSON for flexibility
  // Example: {"color": "Red", "size": "Medium"} or {"length": "250mm", "finish": "Chrome"}
  attributes    Json

  // Variant-specific pricing (overrides base product pricing)
  costPrice     Decimal        @db.Decimal(10, 2)
  sellingPrice  Decimal        @db.Decimal(10, 2)
  reorderLevel  Int            @default(10)
  binLocation   String?
  status        VariantStatus  @default(ACTIVE)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  product          Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  poItems          POItem[]
  inventory        Inventory[]
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  invoiceItems     InvoiceItem[]

  @@index([productId])
  @@index([sku])
  @@index([status])
  @@map("product_variants")
}

model POItem {
  id              String          @id @default(cuid())
  poId            String
  productId       String
  productVariantId String?       // Optional: references specific variant
  quantity        Int
  unitCost        Decimal         @db.Decimal(10, 2)
  totalCost       Decimal         @db.Decimal(12, 2)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       String?
  updatedBy       String?

  purchaseOrder   PurchaseOrder   @relation(fields: [poId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([poId])
  @@index([productId])
  @@index([productVariantId])
  @@map("po_items")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  roleId       String
  status       String    @default("active") // active, inactive
  lastLoginAt  DateTime?
  tenantId     String?   // For multi-tenant Phase 3 (not enforced in MVP)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  role                Role              @relation(fields: [roleId], references: [id])
  auditLogs           AuditLog[]
  stockMovements      StockMovement[]
  createdAdjustments  StockAdjustment[] @relation("AdjustmentCreator")
  reviewedAdjustments StockAdjustment[] @relation("AdjustmentReviewer")
  payments            Payment[]         @relation("PaymentRecorder")

  @@index([email])
  @@index([roleId])
  @@index([status])
  @@index([tenantId])
  @@map("users")
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  action        String   // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
  entityType    String   // User, Product, Invoice, Payment, etc.
  entityId      String?
  timestamp     DateTime @default(now())
  ipAddress     String?
  userAgent     String?
  changedFields Json?    // { field: { old: value, new: value } }
  notes         String?  @db.Text

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
  @@index([action])
  @@map("audit_logs")
}

// ============================================================================
// PAYMENT TRACKING (Epic 2.10)
// ============================================================================

enum PaymentType {
  SUPPLIER
  CLIENT
}

enum PaymentReferenceType {
  PO
  INVOICE
  GENERAL
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
}

model Payment {
  id                   String                 @id @default(cuid())
  supplierId           String?
  paymentType          PaymentType
  paymentReferenceType PaymentReferenceType?
  referenceId          String?                // PO ID or Invoice ID
  amount               Decimal                @db.Decimal(12, 2)
  method               PaymentMethod
  date                 DateTime
  notes                String?                @db.Text
  recordedBy           String

  createdAt            DateTime               @default(now())

  supplier             Supplier?              @relation(fields: [supplierId], references: [id])
  user                 User                   @relation("PaymentRecorder", fields: [recordedBy], references: [id])

  @@index([paymentType, paymentReferenceType, referenceId])
  @@index([supplierId])
  @@index([date])
  @@map("payments")
}

// ============================================================================
// CLIENT MANAGEMENT (Epic 3.1)
// ============================================================================

enum ClientStatus {
  ACTIVE
  INACTIVE
}

model Client {
  id              String       @id @default(cuid())
  name            String
  contactPerson   String?
  phone           String?
  email           String?
  city            String?
  area            String?
  creditLimit     Decimal      @db.Decimal(12, 2) @default(0)
  paymentTermsDays Int         @default(30)
  balance         Decimal      @db.Decimal(12, 2) @default(0)
  status          ClientStatus @default(ACTIVE)

  // Tax exemption (Story 3.5)
  taxExempt       Boolean      @default(false)
  taxExemptReason String?      @db.Text

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  invoices        Invoice[]

  @@map("clients")
}

// ============================================================================
// SYSTEM SETTINGS (Story 3.2)
// ============================================================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique  // e.g., "TAX_RATE", "CURRENCY", "BUSINESS_NAME"
  value     String   @db.Text
  dataType  String   // "number", "string", "boolean"
  label     String   // Human-readable label
  category  String?  // "tax", "general", "invoice", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}

// ============================================================================
// SALES INVOICES (Story 3.2)
// ============================================================================

enum InvoiceStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum InvoicePaymentType {
  CASH
  CREDIT
}

model Invoice {
  id            String               @id @default(cuid())
  invoiceNumber String               @unique
  clientId      String
  warehouseId   String
  invoiceDate   DateTime
  dueDate       DateTime
  paymentType   InvoicePaymentType
  subtotal      Decimal              @db.Decimal(12, 2)
  taxAmount     Decimal              @db.Decimal(12, 2)
  taxRate       Decimal              @db.Decimal(5, 2) @default(0) // Snapshot of tax rate at creation (Story 3.5)
  total         Decimal              @db.Decimal(12, 2)
  paidAmount    Decimal              @db.Decimal(12, 2) @default(0)
  status        InvoiceStatus        @default(PENDING)
  notes         String?              @db.Text

  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  client        Client               @relation(fields: [clientId], references: [id])
  warehouse     Warehouse            @relation(fields: [warehouseId], references: [id])
  items         InvoiceItem[]

  @@index([clientId])
  @@index([warehouseId])
  @@index([status])
  @@index([invoiceDate])
  @@map("invoices")
}

model InvoiceItem {
  id               String          @id @default(cuid())
  invoiceId        String
  productId        String
  productVariantId String?
  batchNo          String?
  quantity         Int
  unitPrice        Decimal         @db.Decimal(10, 2)
  discount         Decimal         @db.Decimal(5, 2) @default(0)
  total            Decimal         @db.Decimal(12, 2)

  invoice          Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product          Product         @relation(fields: [productId], references: [id])
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@index([productVariantId])
  @@map("invoice_items")
}
