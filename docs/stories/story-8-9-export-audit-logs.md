# Story 8.9: Export Audit Logs to Excel

**Epic:** Epic 8 - Audit Trail Viewer & Advanced Features
**Story ID:** STORY-8.9
**Priority:** Medium
**Estimated Effort:** 4-6 hours
**Dependencies:** Story 8.1
**Status:** Draft — Phase 2 (v2.0 — Revised)

---

## User Story

**As an** admin,
**I want** to export audit logs to Excel for compliance and archiving,
**So that** audit data can be reviewed offline or submitted to auditors.

---

## Acceptance Criteria

1. **Backend API:**
   - [ ] GET /api/v1/audit-logs/export - generates Excel file
   - [ ] Parameters: same filters as audit log viewer (userId, entityType, action, date range)
   - [ ] File naming: `audit-log-{from-date}-to-{to-date}.xlsx`

2. **Excel File Contents:**
   - [ ] Export metadata (generated by, generated at, filters applied)
   - [ ] Audit log table: Timestamp, User Name, User Email, Action, Entity Type, Entity ID, IP Address, Changed Fields
   - [ ] Changed fields expanded (JSON stringified with old/new values)
   - [ ] Formatted columns (timestamps, user-friendly action names)

3. **Excel Styling:**
   - [ ] Headers bold with blue background
   - [ ] Alternating row colors
   - [ ] Fixed column widths
   - [ ] Freeze header row (ySplit at row 6 to account for metadata rows)

4. **Performance:**
   - [ ] Export includes all matching records (up to 50,000 rows)
   - [ ] < 10 seconds for 10,000 rows

5. **Frontend:**
   - [ ] "Export to Excel" button on Audit Trail page
   - [ ] Loading state during export
   - [ ] Triggers browser download when complete
   - [ ] Success/error toast notifications

6. **Authorization:**
   - [ ] Only Admin can export audit logs

---

## Dev Notes

### Backend -- Export Service

```typescript
import ExcelJS from 'exceljs';
import { prisma } from '../prisma.js';

async function exportAuditLogs(
  filters: AuditLogFilters,
  userId: string
): Promise<Buffer> {
  // Get all matching logs (no pagination)
  const logs = await prisma.auditLog.findMany({
    where: buildWhereClause(filters),
    include: {
      user: {
        select: { name: true, email: true }
      }
    },
    orderBy: { timestamp: 'desc' },
    take: 50000 // Limit to prevent memory issues
  });

  // Get user info for metadata
  const exportedBy = await prisma.user.findUnique({
    where: { id: userId },
    select: { name: true, email: true }
  });

  // Create workbook
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Audit Logs');

  // Add metadata
  worksheet.addRow(['Audit Log Export']);
  worksheet.addRow(['Generated by:', exportedBy?.name]);
  worksheet.addRow(['Generated at:', new Date().toISOString()]);
  worksheet.addRow(['Filters:', JSON.stringify(filters)]);
  worksheet.addRow([]); // Empty row

  // Add headers
  const headerRow = worksheet.addRow([
    'Timestamp',
    'User Name',
    'User Email',
    'Action',
    'Entity Type',
    'Entity ID',
    'IP Address',
    'Changed Fields'
  ]);

  headerRow.font = { bold: true };
  headerRow.fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FF4F81BD' }
  };
  headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

  // Add data rows
  logs.forEach((log, index) => {
    const row = worksheet.addRow([
      log.timestamp,
      log.user.name,
      log.user.email,
      log.action,
      log.entityType,
      log.entityId || 'N/A',
      log.ipAddress || 'N/A',
      log.changedFields ? JSON.stringify(log.changedFields) : '-'
    ]);

    // Alternating row colors
    if (index % 2 === 1) {
      row.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFF5F5F5' }
      };
    }
  });

  // Format columns
  worksheet.getColumn(1).numFmt = 'yyyy-mm-dd hh:mm:ss';
  worksheet.getColumn(1).width = 20;
  worksheet.getColumn(2).width = 25;
  worksheet.getColumn(3).width = 30;
  worksheet.getColumn(4).width = 15;
  worksheet.getColumn(5).width = 20;
  worksheet.getColumn(6).width = 30;
  worksheet.getColumn(7).width = 15;
  worksheet.getColumn(8).width = 40;

  // Freeze rows (metadata + header = 6 rows)
  worksheet.views = [{ state: 'frozen', ySplit: 6 }];

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer as Buffer;
}
```

### Backend -- Route Handler

```typescript
// In routes/audit-logs.routes.ts
router.get('/export', requireRole('ADMIN'), async (req: Request, res: Response) => {
  const filters: AuditLogFilters = {
    userId: req.query.userId as string | undefined,
    entityType: req.query.entityType as string | undefined,
    action: req.query.action as string | undefined,
    dateFrom: req.query.dateFrom ? new Date(req.query.dateFrom as string) : undefined,
    dateTo: req.query.dateTo ? new Date(req.query.dateTo as string) : undefined
  };

  const buffer = await exportAuditLogs(filters, req.user!.id);

  const fromDate = filters.dateFrom ? format(filters.dateFrom, 'yyyy-MM-dd') : 'all';
  const toDate = filters.dateTo ? format(filters.dateTo, 'yyyy-MM-dd') : 'today';
  const filename = `audit-log-${fromDate}-to-${toDate}.xlsx`;

  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
  res.send(buffer);
});
```

### Frontend -- Export Button

Uses `apiClient` instead of raw `fetch()` to ensure auth token is included.

```tsx
import { useState, FC } from 'react';
import { format } from 'date-fns';
import toast from 'react-hot-toast';
import { Download } from 'lucide-react';
import { apiClient } from '../../lib/api-client';
import { Button } from '../../components/ui/Button';

interface AuditLogFilters {
  userId?: string;
  entityType?: string;
  action?: string;
  dateFrom?: Date;
  dateTo?: Date;
}

export const ExportAuditLogsButton: FC<{ filters: AuditLogFilters }> = ({ filters }) => {
  const [exporting, setExporting] = useState(false);

  const handleExport = async () => {
    setExporting(true);

    try {
      const params = new URLSearchParams();
      if (filters.userId) params.set('userId', filters.userId);
      if (filters.entityType) params.set('entityType', filters.entityType);
      if (filters.action) params.set('action', filters.action);
      if (filters.dateFrom) params.set('dateFrom', filters.dateFrom.toISOString());
      if (filters.dateTo) params.set('dateTo', filters.dateTo.toISOString());

      // Use apiClient for auth token, but request blob response
      const response = await apiClient.get(`/audit-logs/export?${params.toString()}`, {
        responseType: 'blob'
      });

      const blob = new Blob([response.data], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `audit-log-${format(filters.dateFrom || new Date(), 'yyyy-MM-dd')}-to-${format(filters.dateTo || new Date(), 'yyyy-MM-dd')}.xlsx`;
      link.click();
      window.URL.revokeObjectURL(url);

      toast.success('Audit logs exported successfully');
    } catch (error) {
      toast.error('Export failed');
    } finally {
      setExporting(false);
    }
  };

  return (
    <Button onClick={handleExport} disabled={exporting}>
      <Download className="h-4 w-4 mr-2" />
      {exporting ? 'Exporting...' : 'Export to Excel'}
    </Button>
  );
};
```

---

### Key Corrections (from v1.0)

1. **API path corrected** -- `/api/audit-logs/export` changed to `/api/v1/audit-logs/export`. The `apiClient` base URL already includes `/api/v1`, so the frontend call uses `/audit-logs/export`.
2. **Frontend uses `apiClient` instead of raw `fetch()`** -- ensures the JWT auth token is automatically included via the request interceptor. Uses `responseType: 'blob'` for binary download.
3. **Added `window.URL.revokeObjectURL()`** -- cleanup to prevent memory leaks from blob URLs.
4. **Filter params only set when present** -- v1.0 set all params to empty strings. Revised to only include non-empty filters in query params.
5. **Added route handler example** -- shows the Express route with proper content-type headers and auth middleware.
6. **entityId correctly shown as nullable** -- `log.entityId || 'N/A'` since entityId is `String?` in the AuditLog model.

---

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-01-15 | 1.0     | Initial story creation | Sarah (Product Owner) |
| 2026-02-10 | 2.0     | Revision: fix API path to /api/v1/, replace fetch() with apiClient (blob responseType), add route handler example, clean up filter params handling, add blob URL cleanup | Claude (Dev Review) |
