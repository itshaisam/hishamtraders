# Story 8.9: Export Audit Logs to Excel

**Epic:** Epic 8 - Audit Trail Viewer & Advanced Features
**Story ID:** STORY-8.9
**Priority:** Medium
**Estimated Effort:** 4-6 hours
**Dependencies:** Story 8.1
**Status:** Draft - Phase 2

---

## User Story

**As an** admin,
**I want** to export audit logs to Excel for compliance and archiving,
**So that** audit data can be reviewed offline or submitted to auditors.

---

## Acceptance Criteria

1. **Backend API:**
   - [ ] GET /api/audit-logs/export - generates Excel file
   - [ ] Parameters: same filters as audit log viewer (userId, entityType, action, date range)
   - [ ] File naming: `audit-log-{from-date}-to-{to-date}.xlsx`

2. **Excel File Contents:**
   - [ ] Export metadata (generated by, generated at, filters applied)
   - [ ] Audit log table: Timestamp, User, Action, Entity Type, Entity ID, IP Address, Changed Fields
   - [ ] Changed fields expanded (one column per field with old â†’ new values)
   - [ ] Formatted columns (timestamps, user-friendly action names)

3. **Excel Styling:**
   - [ ] Headers bold
   - [ ] Alternating row colors
   - [ ] Auto-sized columns
   - [ ] Freeze top row

4. **Performance:**
   - [ ] Export includes all matching records (up to 50,000 rows)
   - [ ] < 10 seconds for 10,000 rows

5. **Frontend:**
   - [ ] "Export to Excel" button on Audit Trail page
   - [ ] Progress indicator during export
   - [ ] Triggers download when complete

6. **Authorization:**
   - [ ] Only Admin can export audit logs

---

## Dev Notes

```typescript
import ExcelJS from 'exceljs';

async function exportAuditLogs(
  filters: AuditLogFilters,
  userId: string
): Promise<Buffer> {
  // Get all matching logs (no pagination)
  const logs = await prisma.auditLog.findMany({
    where: buildWhereClause(filters),
    include: {
      user: {
        select: { name: true, email: true }
      }
    },
    orderBy: { timestamp: 'desc' },
    take: 50000 // Limit to prevent memory issues
  });

  // Get user info for metadata
  const exportedBy = await prisma.user.findUnique({
    where: { id: userId },
    select: { name: true, email: true }
  });

  // Create workbook
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Audit Logs');

  // Add metadata
  worksheet.addRow(['Audit Log Export']);
  worksheet.addRow(['Generated by:', exportedBy?.name]);
  worksheet.addRow(['Generated at:', new Date().toISOString()]);
  worksheet.addRow(['Filters:', JSON.stringify(filters)]);
  worksheet.addRow([]); // Empty row

  // Add headers
  const headerRow = worksheet.addRow([
    'Timestamp',
    'User Name',
    'User Email',
    'Action',
    'Entity Type',
    'Entity ID',
    'IP Address',
    'Changed Fields'
  ]);

  headerRow.font = { bold: true };
  headerRow.fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FF4F81BD' }
  };
  headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

  // Add data rows
  logs.forEach((log, index) => {
    const row = worksheet.addRow([
      log.timestamp,
      log.user.name,
      log.user.email,
      log.action,
      log.entityType,
      log.entityId,
      log.ipAddress || 'N/A',
      log.changedFields ? JSON.stringify(log.changedFields) : '-'
    ]);

    // Alternating row colors
    if (index % 2 === 1) {
      row.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFF5F5F5' }
      };
    }
  });

  // Format columns
  worksheet.getColumn(1).numFmt = 'yyyy-mm-dd hh:mm:ss';
  worksheet.getColumn(1).width = 20;
  worksheet.getColumn(2).width = 25;
  worksheet.getColumn(3).width = 30;
  worksheet.getColumn(4).width = 15;
  worksheet.getColumn(5).width = 20;
  worksheet.getColumn(6).width = 30;
  worksheet.getColumn(7).width = 15;
  worksheet.getColumn(8).width = 40;

  // Freeze top row
  worksheet.views = [{ state: 'frozen', ySplit: 6 }];

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer as Buffer;
}
```

**Frontend:**
```tsx
export const ExportAuditLogsButton: FC<{ filters: AuditLogFilters }> = ({ filters }) => {
  const [exporting, setExporting] = useState(false);

  const handleExport = async () => {
    setExporting(true);

    try {
      const params = new URLSearchParams({
        userId: filters.userId || '',
        entityType: filters.entityType || '',
        action: filters.action || '',
        dateFrom: filters.dateFrom?.toISOString() || '',
        dateTo: filters.dateTo?.toISOString() || ''
      });

      const response = await fetch(`/api/audit-logs/export?${params}`);
      const blob = await response.blob();

      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `audit-log-${format(filters.dateFrom || new Date(), 'yyyy-MM-dd')}-to-${format(filters.dateTo || new Date(), 'yyyy-MM-dd')}.xlsx`;
      link.click();

      toast.success('Audit logs exported successfully');
    } catch (error) {
      toast.error('Export failed');
    } finally {
      setExporting(false);
    }
  };

  return (
    <Button onClick={handleExport} disabled={exporting}>
      <Download className="h-4 w-4 mr-2" />
      {exporting ? 'Exporting...' : 'Export to Excel'}
    </Button>
  );
};
```

---

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-01-15 | 1.0     | Initial story creation | Sarah (Product Owner) |
