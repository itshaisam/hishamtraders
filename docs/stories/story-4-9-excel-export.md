# Story 4.9: Excel Export Functionality

**Epic:** Epic 4 - Dashboards & Reports
**Story ID:** STORY-4.9
**Priority:** Medium
**Estimated Effort:** 6-8 hours
**Dependencies:** All report stories (4.4-4.8)
**Status:** Draft

---

## User Story

**As a** user,
**I want** all reports to be exportable to Excel format,
**So that** data can be further analyzed in spreadsheets.

---

## Acceptance Criteria

1. **Excel Export Implementation:**
   - [ ] All report endpoints support Excel export
   - [ ] Use exceljs or xlsx library (Node.js backend)
   - [ ] Excel file includes: report title, filters, timestamp, generated by
   - [ ] Styled headers (bold, background color)
   - [ ] Column auto-sizing
   - [ ] Number formatting (currency, decimals)
   - [ ] Summary rows with formulas

2. **Download Mechanism:**
   - [ ] Content-Disposition: attachment with filename
   - [ ] Filename format: `{report-type}-{date}.xlsx`

3. **Performance:**
   - [ ] Export all data (not paginated, up to 10,000 rows)
   - [ ] Performance: <5 seconds for 1000 rows

4. **Frontend:**
   - [ ] "Export to Excel" button on all report pages

---

## Dev Notes

```typescript
import ExcelJS from 'exceljs';

async function exportStockReportToExcel(
  data: StockReportItem[],
  filters: any,
  userName: string
): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Stock Report');

  // Add title and metadata
  worksheet.addRow(['Stock Report']);
  worksheet.addRow([`Generated: ${format(new Date(), 'PPpp')}`]);
  worksheet.addRow([`Generated By: ${userName}`]);
  worksheet.addRow([`Filters: ${JSON.stringify(filters)}`]);
  worksheet.addRow([]); // Empty row

  // Add headers
  const headerRow = worksheet.addRow([
    'Product',
    'SKU',
    'Category',
    'Warehouse',
    'Batch',
    'Quantity',
    'Cost Price',
    'Stock Value'
  ]);

  headerRow.font = { bold: true };
  headerRow.fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FF4F81BD' }
  };
  headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };

  // Add data rows
  data.forEach(item => {
    worksheet.addRow([
      item.productName,
      item.sku,
      item.category,
      item.warehouse,
      item.batchNo,
      item.quantity,
      item.costPrice,
      item.stockValue
    ]);
  });

  // Add summary row
  const summaryRow = worksheet.addRow([
    'TOTAL',
    '',
    '',
    '',
    '',
    '',
    '',
    { formula: `SUM(H6:H${worksheet.rowCount})` }
  ]);
  summaryRow.font = { bold: true };

  // Format currency columns
  worksheet.getColumn(7).numFmt = '"Rs."#,##0.00';
  worksheet.getColumn(8).numFmt = '"Rs."#,##0.00';

  // Auto-size columns
  worksheet.columns.forEach(column => {
    let maxLength = 0;
    column.eachCell({ includeEmpty: true }, cell => {
      const length = cell.value ? cell.value.toString().length : 10;
      if (length > maxLength) {
        maxLength = length;
      }
    });
    column.width = Math.min(maxLength + 2, 50);
  });

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer as Buffer;
}

// Controller
router.get('/api/reports/stock/export', async (req, res) => {
  const filters = req.query;
  const data = await getStockReport(filters);

  const buffer = await exportStockReportToExcel(
    data.items,
    filters,
    req.user.name
  );

  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.setHeader('Content-Disposition', `attachment; filename="stock-report-${format(new Date(), 'yyyy-MM-dd')}.xlsx"`);
  res.send(buffer);
});
```

**Frontend Implementation:**

```typescript
const handleExportExcel = async () => {
  try {
    const response = await fetch(`/api/reports/stock/export?${new URLSearchParams(filters)}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stock-report-${format(new Date(), 'yyyy-MM-dd')}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);

    toast.success('Report exported successfully');
  } catch (error) {
    toast.error('Failed to export report');
  }
};
```

---

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-01-15 | 1.0     | Initial story creation | Sarah (Product Owner) |
