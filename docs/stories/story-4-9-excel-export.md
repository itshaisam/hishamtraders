# Story 4.9: Excel Export Functionality

**Epic:** Epic 4 - Dashboards & Reports
**Story ID:** STORY-4.9
**Priority:** Medium
**Estimated Effort:** 4-6 hours
**Dependencies:** At least one report story (4.4-4.8) implemented
**Status:** Implemented

---

## User Story

**As a** user,
**I want** reports to be exportable to Excel format,
**So that** data can be further analyzed in spreadsheets.

---

## Acceptance Criteria

1. **Excel Export:**
   - [x] All report endpoints support `?format=xlsx` query parameter
   - [x] Use `exceljs` library (Node.js backend) for Excel generation
   - [x] Excel file includes: report title row, filter summary row, timestamp, generated-by user
   - [x] Styled headers (bold, colored background)
   - [x] Column auto-sizing
   - [x] Number formatting (currency as `"Rs."#,##0.00`)
   - [x] Summary row at bottom with totals

2. **Download Mechanism:**
   - [x] Response `Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
   - [x] `Content-Disposition: attachment; filename="{report-type}-{date}.xlsx"`
   - [x] Frontend triggers download via blob URL

3. **Limits:**
   - [x] Max 10,000 rows per export (server-side validation)
   - [x] Export returns all matching rows (ignores pagination), up to the 10K limit
   - [x] Return 400 if result set exceeds limit, with message to narrow filters

4. **Frontend:**
   - [x] "Export to Excel" button on every report page
   - [x] Button disabled during active export (shows spinner)
   - [x] Success: browser downloads file, toast notification
   - [x] Error: toast with reason (too many rows, timeout, server error)

5. **Authorization:**
   - [x] Same authorization as the underlying report endpoint
   - [x] No additional export-specific permissions for MVP

---

## Dev Notes

### Implementation Status

**Backend:** Implemented. `exceljs` installed. Shared `generateExcel()` utility at `apps/api/src/utils/excel-export.util.ts`. 10 export handlers in `reports.controller.ts` with `/export` suffix routes.

**Frontend:** Implemented. `useExportExcel` hook at `apps/web/src/hooks/useExportExcel.ts`. All report pages have PDF (client-side jsPDF) and Excel (server-side exceljs) export buttons with loading spinner.

### Approach: Shared Export Utility

Create a reusable export utility that any report controller can call:

```typescript
// apps/api/src/utils/excel-export.util.ts

import ExcelJS from 'exceljs';

interface ExportOptions {
  title: string;
  filters: Record<string, string>;
  generatedBy: string;
  columns: { header: string; key: string; width?: number; style?: Partial<ExcelJS.Style> }[];
  data: Record<string, any>[];
  summaryRow?: Record<string, any>;  // optional totals row
}

async function generateExcel(options: ExportOptions): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet(options.title);

  // Metadata rows
  worksheet.addRow([options.title]);
  worksheet.addRow([`Generated: ${new Date().toISOString()}`]);
  worksheet.addRow([`Generated By: ${options.generatedBy}`]);
  worksheet.addRow([`Filters: ${Object.entries(options.filters).map(([k, v]) => `${k}=${v}`).join(', ')}`]);
  worksheet.addRow([]); // spacer

  // Header row
  const headerRow = worksheet.addRow(options.columns.map(c => c.header));
  headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
  headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4F81BD' } };

  // Data rows
  options.data.forEach(row => {
    worksheet.addRow(options.columns.map(c => row[c.key]));
  });

  // Summary row (optional)
  if (options.summaryRow) {
    const sumRow = worksheet.addRow(options.columns.map(c => options.summaryRow![c.key] ?? ''));
    sumRow.font = { bold: true };
  }

  // Auto-size columns
  options.columns.forEach((col, i) => {
    worksheet.getColumn(i + 1).width = col.width || 15;
  });

  // Currency formatting for specified columns
  options.columns.forEach((col, i) => {
    if (col.style?.numFmt) {
      worksheet.getColumn(i + 1).numFmt = col.style.numFmt;
    }
  });

  return (await workbook.xlsx.writeBuffer()) as Buffer;
}
```

### Controller Pattern

Each report controller adds an export variant:

```typescript
// In reports.controller.ts — example for stock report
async function exportStockReport(req: Request, res: Response) {
  const filters = parseFilters(req.query);
  const data = await stockReportService.getStockReport({ ...filters, limit: 10000, offset: 0 });

  if (data.items.length > 10000) {
    throw new BadRequestError('Export limited to 10,000 rows. Please narrow your filters.');
  }

  const buffer = await generateExcel({
    title: 'Stock Report',
    filters: { warehouse: filters.warehouseId || 'All', category: filters.categoryId || 'All' },
    generatedBy: req.user!.name,
    columns: [
      { header: 'Product', key: 'productName', width: 25 },
      { header: 'SKU', key: 'sku', width: 15 },
      { header: 'Category', key: 'category', width: 15 },
      { header: 'Warehouse', key: 'warehouse', width: 15 },
      { header: 'Batch', key: 'batchNo', width: 15 },
      { header: 'Quantity', key: 'quantity', width: 10 },
      { header: 'Cost Price', key: 'costPrice', width: 12, style: { numFmt: '"Rs."#,##0.00' } },
      { header: 'Stock Value', key: 'stockValue', width: 15, style: { numFmt: '"Rs."#,##0.00' } },
    ],
    data: data.items,
    summaryRow: { productName: 'TOTAL', stockValue: data.summary.totalStockValue },
  });

  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.setHeader('Content-Disposition', `attachment; filename="stock-report-${new Date().toISOString().slice(0, 10)}.xlsx"`);
  res.send(buffer);
}
```

### Frontend Download Pattern

```typescript
// Reusable export hook
function useExportExcel() {
  const [isExporting, setIsExporting] = useState(false);

  const exportReport = async (url: string, filename: string) => {
    setIsExporting(true);
    try {
      const response = await api.get(url, { responseType: 'blob' });
      const blobUrl = window.URL.createObjectURL(response.data);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(blobUrl);
      toast.success('Report exported successfully');
    } catch (error: any) {
      const message = error.response?.data?.message || 'Failed to export report';
      toast.error(message);
    } finally {
      setIsExporting(false);
    }
  };

  return { exportReport, isExporting };
}
```

### Route Registration

Add `/export` suffix routes alongside existing report routes:

```
GET /api/v1/reports/stock/export
GET /api/v1/reports/stock-valuation/export
GET /api/v1/reports/sales/export
GET /api/v1/reports/sales-by-client/export
GET /api/v1/reports/sales-by-product/export
GET /api/v1/reports/payments/export
GET /api/v1/reports/receivables/export
GET /api/v1/reports/imports/export
GET /api/v1/reports/expenses/export
GET /api/v1/reports/expenses-by-category/export
```

### Module Structure

```
apps/api/src/utils/
  excel-export.util.ts          (NEW — shared generateExcel utility)

apps/api/src/modules/reports/
  reports.controller.ts         (EXPAND — add export handlers)
  reports.routes.ts             (EXPAND — add /export routes)

apps/web/src/hooks/
  useExportExcel.ts             (NEW — reusable export hook)
```

### Dependencies

```bash
cd apps/api && pnpm add exceljs
```

### POST-MVP DEFERRED

- **CSV export**: Not needed for MVP. Excel covers all use cases. Add later if requested.
- **Background queue / email notifications for large exports**: Over-engineered. Synchronous export with 10K row limit is sufficient.
- **Progress bar**: Exports should complete in <5 seconds for 10K rows. No progress needed.
- **Export history**: Not needed. User downloads the file immediately.
- **Retry with exponential backoff**: Not needed. If export fails, user clicks button again.
- **Per-role export restrictions**: Same as read access for MVP. No additional export-specific permissions.
- **500MB file size limits / concurrent export limits / rate limiting**: Over-engineered. 10K rows at ~50 bytes/row = ~500KB. Not a concern.
