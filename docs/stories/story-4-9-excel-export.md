# Story 4.9: Excel Export Functionality

**Epic:** Epic 4 - Dashboards & Reports
**Story ID:** STORY-4.9
**Priority:** Medium
**Estimated Effort:** 6-8 hours
**Dependencies:** All report stories (4.4-4.8)
**Status:** Draft

---

## User Story

**As a** user,
**I want** all reports to be exportable to Excel format,
**So that** data can be further analyzed in spreadsheets.

---

## Acceptance Criteria

1. **Excel & CSV Export Implementation:**
   - [ ] All report endpoints support Excel export.
   - [ ] All reports also support exporting to CSV format.
   - [ ] Use exceljs or xlsx library (Node.js backend) for Excel.
   - [ ] Use a standard CSV stringifier for CSV.
   - [ ] Excel file includes: report title, filters, timestamp, generated by.
   - [ ] Styled headers (bold, background color) for Excel.
   - [ ] Column auto-sizing for Excel.
   - [ ] Number formatting (currency, decimals) for Excel.
   - [ ] Summary rows with formulas for Excel.

2. **Download Mechanism:**
   - [ ] Content-Disposition: attachment with filename.
   - [ ] Filename format: `{report-type}-{date}.{format}` (where format is `xlsx` or `csv`).

3. **Performance & Timeout Handling:**
   - [ ] Export all data (not paginated, up to 10,000 rows)
   - [ ] Performance: <5 seconds for 1000 rows, <30 seconds max
   - [ ] Default timeout: 30 seconds per export
   - [ ] Retry mechanism: Automatic 3 retries with exponential backoff (1s, 2s, 4s)
   - [ ] Show progress indicator for exports >5 seconds
   - [ ] Queue large exports (>5000 rows) for background processing
   - [ ] Notify user via toast + optional email when large export ready

4. **Error Handling & Validation:**
   - [ ] Network timeout: Show retry button + offline notification
   - [ ] File generation error: Log stack trace + return user-friendly message
   - [ ] Invalid filters: Return 400 with validation errors
   - [ ] Permission denied: Return 403 with reason
   - [ ] Server error: 500 with ticket number for support
   - [ ] Max rows per export: 10,000 (enforce server-side)
   - [ ] Max file size: 500MB (enforce server-side)
   - [ ] Max concurrent exports: 5 per user (queue additional requests)
   - [ ] Rate limit: 1 export per 5 seconds per user

5. **Export Authorization & Limits:**
   - [ ] Admin/Accountant: Can export all reports
   - [ ] Sales Officer: Can export own sales only
   - [ ] Warehouse Manager: Can export warehouse reports only
   - [ ] Recovery Agent: Can export payment/receivables only
   - [ ] Other roles: 403 Forbidden for export functionality
   - [ ] Enforce filters validation: Date ranges, field presence

6. **Frontend:**
   - [ ] "Export to Excel" button on all report pages
   - [ ] Show loading spinner + cancel button during export
   - [ ] Progress bar for exports >5 seconds
   - [ ] Success notification with download link
   - [ ] Error toast with specific reason + retry button
   - [ ] Disable export button during active export
   - [ ] Show export history (last 5 exports)

---

## Dev Notes

```typescript
import ExcelJS from 'exceljs';

async function exportStockReportToExcel(
  data: StockReportItem[],
  filters: any,
  userName: string
): Promise<Buffer> {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Stock Report');

  // Add title and metadata
  worksheet.addRow(['Stock Report']);
  worksheet.addRow([`Generated: ${format(new Date(), 'PPpp')}`]);
  worksheet.addRow([`Generated By: ${userName}`]);
  worksheet.addRow([`Filters: ${JSON.stringify(filters)}`]);
  worksheet.addRow([]); // Empty row

  // Add headers
  const headerRow = worksheet.addRow([
    'Product',
    'SKU',
    'Category',
    'Warehouse',
    'Batch',
    'Quantity',
    'Cost Price',
    'Stock Value'
  ]);

  headerRow.font = { bold: true };
  headerRow.fill = {
    type: 'pattern',
    pattern: 'solid',
    fgColor: { argb: 'FF4F81BD' }
  };
  headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };

  // Add data rows
  data.forEach(item => {
    worksheet.addRow([
      item.productName,
      item.sku,
      item.category,
      item.warehouse,
      item.batchNo,
      item.quantity,
      item.costPrice,
      item.stockValue
    ]);
  });

  // Add summary row
  const summaryRow = worksheet.addRow([
    'TOTAL',
    '',
    '',
    '',
    '',
    '',
    '',
    { formula: `SUM(H6:H${worksheet.rowCount})` }
  ]);
  summaryRow.font = { bold: true };

  // Format currency columns
  worksheet.getColumn(7).numFmt = '"Rs."#,##0.00';
  worksheet.getColumn(8).numFmt = '"Rs."#,##0.00';

  // Auto-size columns
  worksheet.columns.forEach(column => {
    let maxLength = 0;
    column.eachCell({ includeEmpty: true }, cell => {
      const length = cell.value ? cell.value.toString().length : 10;
      if (length > maxLength) {
        maxLength = length;
      }
    });
    column.width = Math.min(maxLength + 2, 50);
  });

  // Generate buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer as Buffer;
}

// Controller
router.get('/api/reports/stock/export', async (req, res) => {
  const filters = req.query;
  const data = await getStockReport(filters);

  const buffer = await exportStockReportToExcel(
    data.items,
    filters,
    req.user.name
  );

  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.setHeader('Content-Disposition', `attachment; filename="stock-report-${format(new Date(), 'yyyy-MM-dd')}.xlsx"`);
  res.send(buffer);
});
```

**Frontend Implementation:**

```typescript
const handleExportExcel = async () => {
  try {
    const response = await fetch(`/api/reports/stock/export?${new URLSearchParams(filters)}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stock-report-${format(new Date(), 'yyyy-MM-dd')}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);

    toast.success('Report exported successfully');
  } catch (error) {
    toast.error('Failed to export report');
  }
};
```

---

## Change Log

| Date       | Version | Description            | Author |
|------------|---------|------------------------|--------|
| 2025-01-15 | 1.0     | Initial story creation | Sarah (Product Owner) |
